# Часть 17. Роли и разрешения (III) | Управление субадминистраторами (добавление/редактирование)

В этой части мы продолжим совершенствовать систему ролей и разрешений для панели администратора, реализовав функцию добавления/редактирования субадминистраторов. Это позволит суперадминистратору эффективно управлять субадминистраторами, добавляя новых или изменяя существующих.

Эта система управления пользователями на основе ролей имеет решающее значение для любой крупномасштабной платформы электронной коммерции, гарантируя, что субадминистраторы будут иметь только необходимые разрешения для выполнения своих задач.
Подробно описанные шаги:

## Шаг 1. Обновите ```subadmins.blade.php```.

- Добавьте кнопку «Add Subadmin» в правом верхнем углу.
```
<div class="card-header">
    <h3 class="card-title">Subadmins</h3>
    <a style="max-width: 150px; float:right; display: inline-block;"
       href="{{ url('admin/add-edit-subadmin') }}"
       class="btn btn-block btn-primary">
        Add Subadmin
    </a>
</div>
```
Добавьте кнопку «Edit» рядом с каждым субадминистратором.
```
&nbsp;&nbsp;<a href="{{ url('admin/add-edit-subadmin/'.$subadmin->id) }}">
    <i class="fas fa-edit"></i>
</a>
```
## Шаг 2. Создайте маршрут для формы добавления/редактирования субадминистратора

Добавьте маршрут ```GET``` в ```web.php``` для отображения формы субадминистрирования.
```
Route::get('add-edit-subadmin/{id?}', [AdminController::class, 'addEditSubadmin']);
```
## Шаг 3. Создайте функцию addEditSubadmin в AdminController

Эта функция отвечает за отображение формы добавления/редактирования субадминистратора.

Она определяет, должна ли форма находиться в режиме добавления или редактирования в зависимости от наличия идентификатора.

Возвращает форму добавления/редактирования субадминистратора (```add_edit_subadmin.blade.php```).
```
public function addEditSubadmin($id = null)
{
    if ($id == null) {
        $title = "Add Subadmin";
        $subadmin_data = array();
    } else {
        $title = "Edit Subadmin";
        $subadmin_data = Admin::find($id);
    }
    return view('admin.subadmins.add_edit_subadmin', compact('title', 'subadmin_data'));
}
```
## Шаг 4. Создайте ```add_edit_subadmin.blade.php``` для формы добавления/редактирования

- Включите поля «Name», «Email», «Password», «Mobile» и «Profile Image».
- Используйте **условную логику** для управления полями формы в зависимости от того, добавляется или редактируется субадминистратор.
```
<form name="subadminForm" id="subadminForm" method="post"
      action="{{ url('admin/add-edit-subadmin/request') }}"
      enctype="multipart/form-data">
    @csrf
    @if(!empty($subadmin_data['id']))
        <input type="hidden" name="id" value="{{ $subadmin_data['id'] }}">
    @endif
    <!--begin::Body-->
    <div class="card-body">
        <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" name="email"
                   placeholder="Enter Email"
                   @if(!empty($subadmin_data['email'])) value="{{ $subadmin_data['email'] }}" readonly style="background-color: #cccccc" @endif>
        </div>
        <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password"
                   name="password" placeholder="Enter Password">
        </div>
        <div class="mb-3">
            <label for="name" class="form-label">Name</label>
            <input type="text" class="form-control" id="name" name="name"
                   placeholder="Enter Name"
                   @if(!empty($subadmin_data['name'])) value="{{ $subadmin_data['name'] }}" @endif>
        </div>
        <div class="mb-3">
            <label for="mobile" class="form-label">Mobile</label>
            <input type="text" class="form-control" id="mobile" name="mobile"
                   placeholder="Enter Mobile"
                   @if(!empty($subadmin_data['mobile'])) value="{{ $subadmin_data['mobile'] }}" @endif>
        </div>
        <div class="mb-3">
            <label for="image" class="form-label">Image</label>
            <input type="file" class="form-control" name="image"
                   id="image" accept="image/*">
            @if(!empty($subadmin_data['image']))
                <a target="_blank" href="{{ url('admin/images/photos' . $subadmin_data['image']) }}">View Photo</a>
                <input type="hidden" name="current_image" value="{{ $subadmin_data['image'] }}">
            @endif
        </div>
    </div>
    <!--end::Body-->
    <!--begin::Footer-->
    <div class="card-footer">
        <button type="submit" class="btn btn-primary">Submit</button>
    </div>
    <!--end::Footer-->
</form>
```
## Шаг 5. Создайте маршрут POST для отправки формы субадминистрирования

Определите маршрут ```POST``` в ```web.php``` для обработки отправки формы.
```
Route::post('add-edit-subadmin/request', [AdminController::class, 'addEditSubadminRequest']);
```
## Шаг 6. Реализуйте функцию addEditSubadminRequest в AdminController

Создайте эту функцию в ```AdminController```, в которой мы будем вызывать функцию ```addEditSubadmin``` из ```AdminService``` для добавления или обновления субадминистратора.

Поскольку мы уже внедрили ```AdminService``` в конструктор, мы будем использовать его напрямую вместо создания нового экземпляра:
```
public function addEditSubadminRequest(SubadminRequest $request)
{
    if ($request->isMethod('post')) {
        $result = $this->adminService->addEditSubadmin($request);
        return redirect('admin/subadmins')->with('success_message', $result['message']);
    }
}
```
## Шаг 7. Создайте ```SubadminRequest``` для проверки

Чтобы гарантировать достоверность данных субадминистратора, мы создадим класс запроса формы с пользовательскими правилами проверки и сообщениями об ошибках.

1. Создание класса запроса. Выполните следующую команду Artisan:

```php artisan make:request Admin/SubadminRequest```

2. Обновите ```SubadminRequest.php``` с правилами валидации
```
<?php
namespace App\Http\Requests\Admin;

use App\Models\Admin;
use HttpResponseException;
use Illuminate\Contracts\Validation\Validator;
use Illuminate\Foundation\Http\FormRequest;

class SubadminRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'name' => 'required',
            'email' => 'required|email',
            'image' => 'image',
            'mobile' => 'required|numeric',
        ];
    }

    public function messages(): array
    {
        return [
            'name.required' => 'Name is required.',
            'mobile.required' => 'Mobile is required.',
            'mobile.numeric' => 'Valid Mobile is required.',
            'image.image' => 'Valid Image is required.',
            'email.required' => 'Email is required.',
            'email.email' => 'Valid Email is required.',
        ];
    }

    public function withValidator($validator)
    {
        $validator->after(function ($validator) {
            if ($this->input('id') == "") {
                $subadminCount = Admin::where('email', $this->input('email'))->count();
                if ($subadminCount > 0) {
                    $validator->errors()->add('email', 'Email Already Exist.');
                }
            }
        });
    }
    protected function failedValidation(Validator $validator)
    {
        throw new HttpResponseException(
            redirect()->back()->withErrors($validator)->withInput()
        );
    }
}
```

## Шаг 8. Реализуйте функцию ```addEditSubadmin``` в ```AdminService```

- Обработка логики добавления или обновления данных субадминистратора.
- Загружайте и сохраняйте изображения профиля.
- Шифруйте пароли перед их сохранением.
```
public function addEditSubadmin($request): array
{
    $data = $request->all();
    if (isset($data['id']) && $data['id'] != "") {
        $subadmin_data = Admin::find($data['id']);
        $message = "Subadmin updated successfully!";
    } else {
        $subadmin_data = new Admin();
        $message = "Subadmin added successfully!";
    }

    // Upload Admin Image
    if ($request->hasFile('image')) {
        $image_tmp = $request->file('image');
        if ($image_tmp->isValid()) {
            // Create image manager with desired driver
            $manager = new ImageManager(new Driver());
            // Read image from file system
            $image = $manager->read($image_tmp);
            // Get Image Extension
            $extension = $image_tmp->getClientOriginalExtension();
            // Generate New Image Name
            $imageName = rand(111, 99999) . '.' . $extension;
            $image_path = 'admin/images/photos/' . $imageName;
            // Save image in specified path
            $image->save($image_path);
        }
    } elseif (!empty($data['current_image'])) {
        $imageName = $data['current_image'];
    } else {
        $imageName = "";
    }
    
    $subadmin_data->name = $data['name'];
    $subadmin_data->mobile = $data['mobile'];
    $subadmin_data->image = $imageName;
    if (!isset($data['id'])) {
        $subadmin_data->role = "subadmin";
        $subadmin_data->status = 1;
        $subadmin_data->email = $data['email'];
    }
    if ($data['password'] != "") {
        $subadmin_data->password = Hash::make($data['password']);
    }
    $subadmin_data->save();
    return array('message' => $message);
}
```
## Шаг 9. Ограничить вход для неактивных субадминистраторов

Измените функцию ```login``` в ```AdminService```, чтобы гарантировать, что в систему смогут войти только активные субадминистраторы:
```
public function login($data): int
{
    $admin = Admin::where('email', $data['email'])->first();
    if ($admin) {
        if ($admin->status == 0) {
            return "inactive";
        }
        if (Auth::guard('admin')->attempt(['email' => $data['email'], 'password' => $data['password']])) {
            // Remember Admin Email and Password
            if (!empty($data['remember'])) {
                setcookie("email", $data['email'], time() + 3600);
                setcookie("password", $data['password'], time() + 3600);
            } else {
                setcookie("email", "");
                setcookie("password", "");
            }
            return 'success'; // Return success if login is successful
        } else {
           return 'invalid'; // Return invalid if credentials are incorrect
        }
    } else {
        return 'invalid'; // Return invalid if email is not found
    }
}
```
Также обновите функцию ```store``` в ```AdminController``` для обработки различных сообщений:
```
public function store(LoginRequest $request)
{
    $data = $request->all();
    $loginStatus = $this->adminService->login($data);
    if ($loginStatus == 'success') {
        return redirect()->route('dashboard.index');
    } elseif ($loginStatus == 'inactive') {
        return redirect()->back()->with('error_message', 'Your account is inactive, please contact the administrator');
    }
    else {
        return redirect()->back()->with('error_message', 'Invalid Email or Password');
    }
}
```
## Шаг 10. Обновление ```SubadminRequest```

Измените файл ```SubadminRequest.php```, чтобы использовать ```Validator``` и другие классы.
```
use App\Models\Admin;
use Illuminate\Http\Exceptions\HttpResponseException;
use Illuminate\Contracts\Validation\Validator;
```
# Что дальше?

В [следующей части](18.md) мы реализуем роли и разрешения для субадминистраторов, что позволит суперадминистратору контролировать, какие действия может выполнять каждый субадминистратор.

[Оглавление](../README.md)
