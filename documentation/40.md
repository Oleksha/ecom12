# Часть 40. Сортировка альтернативных изображений продукта с помощью перетаскивания
В этой части мы реализуем функцию сортировки альтернативных изображений товаров с помощью перетаскивания в панели администратора. Эта функция улучшает пользовательский опыт и предоставляет администраторам полный контроль над порядком отображения изображений для каждого товара.
## Шаг 1. Обновить add_edit_product.blade.php
Мы модифицируем раздел альтернативных изображений продукта для поддержки сортируемых блоков изображений.
- Для загрузки изображений используется дропзона.
- Мы добавляем контейнер для отображения загруженных изображений в виде миниатюр.
- При загрузке более одного изображения условно отображается строка с инструкцией («Перетащите изображения ниже, чтобы изменить их порядок»).
- Каждое изображение имеет значок удаления и помещено в сортируемые элементы.
```html
<div class="mb-3">
    <label class="form-label" for="product_images_dropzone">
        Alternate Product Images (Multiple Uploads Allowed, Max 500 KB each)
    </label>
    <div class="dropzone" id="productImagesDropzone"></div>

    @if(isset($product->product_images) && $product->product_images->count() > 0)
        @if($product->product_images->count() > 1)
            {{-- Instruction Line --}}
            <p class="drag-instruction">
                <i class="fas fa-arrows-alt"></i> Перетащите изображения ниже, чтобы изменить их порядок.
            </p>
        @endif
        {{-- Контейнер для сортируемых изображений --}}
        <div id="sortable-images" class="sortable-wrapper d-flex gap-2 overflow-auto">
            @foreach($product->product_images as $img)
                <div class="sortable-item" data-id="{{ $img->id }}" style="position: relative;">
                    <a target="_blank"
                       href="{{ url('front/images/products/' . $img->image) }}">
                        <img src="{{ asset('front/images/products/' . $img->image) }}"
                             style="width: 50px" alt="">
                    </a>
                    <a href="javascript:void(0)" class="confirmDelete"
                       data-module="product-image" data-id="{{ $img->id }}"
                       data-image="{{ $img->image }}">
                        <i class="fas fa-trash"
                           style="position: absolute; top: 0; right: 0; color: red;"></i>
                    </a>
                </div>
            @endforeach
        </div>
    @endif

    <!-- Hidden input to collect alternate images -->
    <input type="hidden" name="product_images" id="product_images_hidden">
</div>
```
## Шаг 2. Обновите scripts.blade.php, чтобы включить сортировку jQuery.
Мы включаем переупорядочивание изображений с помощью jQuery UI Sortable и обрабатываем обновление сортировки через AJAX.
- Элемент div #sortable-images теперь можно сортировать по горизонтали.
- После каждой операции перетаскивания новый порядок изображений отправляется на сервер.
- Сортировка ограничена горизонтальной осью для сохранения выравнивания дизайна.
```js
// Product Image Sort Script
$('#sortable-images').sortable({
    helper: 'clone',
    placeholder: 'sortable-placeholder',
    forcePlaceholderSize: true,
    scroll: true,
    axis: 'x', // restrict to horizontal only
    update: function (event, ui) {
        let sortedIds = [];
        $('#sortable_images, .sortable-item').each(function (index) {
            sortedIds.push({
                id: $(this).data('id'),
                sort: index
            });
        });
        $.ajax({
            url: "{{ route('admin.product.update-image-sorting') }}",
            method: "POST",
            data: {
                _token: "{{ csrf_token() }}",
                sorted_images: sortedIds
            }
        });
    }
});
```
## Шаг 3. Добавьте маршрут сортировки изображений в web.php
Мы определяем маршрут для обработки запроса на обновление сортировки изображений.
```php
Route::post('product/update-image-sorting', [ProductController::class, 'updateImageSorting'])->name('admin.product.update-image-sorting');
```
Этот маршрут получает переупорядоченные данные изображения через AJAX и передает их контроллеру.
## Шаг 4. Добавьте функцию updateImageSorting() в ProductController
Этот метод перенаправляет отсортированные данные изображения на уровень обслуживания.
```php
public function updateImageSorting(Request $request)
{
    $this->productService->updateImageSorting($request->sorted_images);
    return response()->json(['status' => 'success']);
}
```
Гарантирует, что контроллер остается «тонким» за счет делегирования логики классу обслуживания.
## Шаг 5. Добавьте updateImageSorting() в ProductService
Мы проходим по отсортированному массиву изображений и обновляем порядок сортировки каждого изображения в базе данных.
```php
public function updateImageSorting(array $sortedImages): void
{
    foreach ($sortedImages as $imageData) {
        if (isset($imageData['id']) && isset($imageData['sort'])) {
            ProductsImage::where('id', $imageData['id'])->update(['sort' => $imageData['sort']]);
        }
    }
}
```
Новая позиция сортировки каждого изображения сохраняется в таблице products_images.
## Шаг 6. Обновите модель Product для сортировки изображений
Гарантирует, что отсортированные изображения отображаются в правильном порядке как на стороне пользователя, так и на стороне пользователя.
```php
public function product_images(): HasMany
{
    return $this->hasMany(ProductsImage::class)->orderBy('sort');
}
```
# Что дальше?
В [следующей части](41.md) мы решим различные проблемы, связанные с Dropzone, связанные с загрузкой и удалением изображений и видео продуктов.

[Оглавление](../README.md)
