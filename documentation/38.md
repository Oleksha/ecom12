# Часть 38. Атрибуты продукта (II) | Интеграция полей добавления/удаления для атрибутов
В этой части мы интегрируем функцию добавления/удаления нескольких полей для динамического управления атрибутами продукта с помощью jQuery.
### Что такое атрибуты продукта?
На платформе электронной коммерции атрибуты продукта относятся к конкретным вариациям товара, таким как размер, артикул, цена, наличие на складе и порядок сортировки. Эти атрибуты помогают различать разные версии одного и того же товара.

Например, красная повседневная футболка может быть доступна в нескольких размерах, каждый из которых имеет свою цену, запасы и артикул:

| Размер | Артикул  | Цена | Запас | Сорт |
|:------:|:--------:|:----:|:-----:|:----:|
| Small  | RCT001-S | 1000 |  10   |  1   |
| Medium | RCT001-M | 1100 |  10   |  2   |
| Large  | RCT001-L | 1200 |  10   |  3   |
## Шаг 1. Найдите скрипт jQuery Add/Remove Fields.
Мы можем искать в Google:
```
Динамическое добавление и удаление поля в jQuery
```
Вместо того чтобы разрабатывать с нуля, мы будем использовать скрипт из надежного источника, например:

Учебное пособие [CodexWorld](https://www.codexworld.com/add-remove-input-fields-dynamically-using-jquery)
## Шаг 2. Обновите custom.js
Добавьте следующую логику jQuery для динамического добавления/удаления:
```js
$(document).ready(function(){

    // Add/Remove Attribute Script
    const maxField = 10; //Input fields increment limitation
    const wrapper = $('.field_wrapper'); //Input field wrapper
    const addButton = '.add_button'; //Add button selector
    const removeTmpl = '<a href="javascript:void(0);" class="btn btn-sm btn-danger remove_button" title="Remove row"><i class="fas fa-minus"></i></a>'; //New input field html

    $(document).on('click', addButton, function(e){
        e.preventDefault();
        if (wrapper.find('.attribute-row').length > maxField) return;
        const row = $(this).closest('.attribute-row').clone();
        row.find('input').val(''); // Clear values
        row.find(addButton).replaceWith(removeTmpl);
        wrapper.append(row);
    });

    wrapper.on('click', '.remove_button', function(e){
        e.preventDefault();
        $(this).closest('.attribute-row').remove(); //Remove field html
    });

    // Весь остальной код файла
    
});
```
## Шаг 3. Обновите форму add_edit_product.blade.php
Добавьте в форму динамические поля атрибутов после поля Вес:
```html
<div class="mb-3">
    <label class="form-label mb-1">Product Attributes</label>
    {{-- Header row --}}
    <div class="d-none d-md-flex fw-semibold bg-light border rounded px-2 py-1 mb-2">
        <div class="flex-fill col-2">Size</div>
        <div class="flex-fill col-2 ms-5">SKU</div>
        <div class="flex-fill col-2 ms-5">Price</div>
        <div class="flex-fill col-2 ms-5">Stock</div>
        <div class="flex-fill col-2 ms-5">Sort</div>
        <div style="width: 60px"></div>
    </div>
    {{-- Dynamic rows --}}
    <div class="field_wrapper">
        {{-- first row --}}
        <div class="d-flex align-items-center gap-2 mb-2 attribute-row">
            <input name="size[]" class="form-control flex-fill col-2" placeholder="Size">
            <input name="sku[]" class="form-control flex-fill col-2" placeholder="SKU">
            <input name="price[]" class="form-control flex-fill col-2" placeholder="Price">
            <input name="stock[]" class="form-control flex-fill col-2" placeholder="Stock">
            <input name="sort[]" class="form-control flex-fill col-2" placeholder="Sort">
            <a href="javascript:void(0)" class="btn btn-sm btn-success add_button" title="Add row">
                <i class="fas fa-plus"></i>
            </a>
        </div>
    </div>
</div>
```
## Шаг 4. Обновите функцию addEditProduct() в ProductService.
Добавьте проверки и логику для сохранения атрибутов в конце функции addEditProduct:
```php
// Add/Edit Product Attributes
// Add Product Attributes
$total_stock = 0;
foreach ($data['sku'] as $key => $value) {
    if (!empty($value) && !empty($data['size'][$key]) && !empty($data['price'][$key])) {
        // SKU already exists check
        $attrCountSKU = ProductsAttribute::join('products', 'products.id', '=', 'products_attributes.product_id')->where('sku', $value)->count();
        if ($attrCountSKU > 0) {
            $message = 'SKU already exists. Please add another SKU!';
            return redirect()->back()->with('success_message', $message);
        }
        // Size already exists check
        $attrCountSize = ProductsAttribute::join('products', 'products.id', '=', 'products_attributes.product_id')
            ->where(['product_id' => $product->id, 'size' => $data['size'][$key]])->count();
        if ($attrCountSize > 0) {
            $message = 'Size already exists. Please add another Size!';
            return redirect()->back()->with('success_message', $message);
        }
        if (empty($data['stock'][$key])) {
            $data['stock'][$key] = 0;
        }
        $attribute = new ProductsAttribute();
        $attribute->product_id = $product->id;
        $attribute->sku = $value;
        $attribute->size = $data['size'][$key];
        $attribute->price = $data['price'][$key];
        if (!empty($data['stock'][$key])) {
            $attribute->stock = $data['stock'][$key];
        }
        $attribute->sort = $data['sort'][$key];
        $attribute->status = 1;
        $attribute->save();
        $total_stock = $total_stock + $data['stock'][$key];
    }
}

// Edit Product Attributes
if (isset($data['id']) && $data['id'] != '' && isset($data['attrId'])) {
    foreach ($data['attrId'] as $key => $attr) {
        if (!empty($attr)) {
            $update_attr = [
                'price' => $data['update_price'][$key],
                'stock' => $data['update_stock'][$key],
                'sort' => $data['update_sort'][$key],
            ];
            ProductsAttribute::where('id', $data['attrId'][$key])->update($update_attr);
        }
    }
}

// Update Product Stock on Edit Product
if (isset($data['attrId'])) {
    foreach ($data['attrId'] as $attrKeyId => $attrIdDetails) {
        $proAttrUpdate = ProductsAttribute::find($attrIdDetails);
        $proAttrUpdate->stock = $data['update_stock'][$attrKeyId];
        $total_stock = $total_stock + $data['update_stock'][$attrKeyId];
    }
}
Product::where('id', $product->id)->update(['stock' => $total_stock]);
```
## Шаг 5. Создайте связь «товар-атрибут»
В модели Product:
```php
public function attributes(): HasMany
{
    return $this->hasMany(ProductsAttribute::class);
}
```
## Шаг 6. Обновление функции редактирования в ProductController
Получить товар с атрибутами:
```php
$product = Product::with(['product_images', 'attributes'])->findOrFail($id);
```
## Шаг 7. Показать существующие атрибуты в форме
Внутри add_edit_product.blade.php:
```html
@if(isset($product['attributes']) && count($product['attributes']) > 0)
    <div class="mb-3">
        <label class="form-label mb-1">Existing Product Attributes</label>
        <div class="table-responsive">
            <table class="table table-bordered align-middle mb-0">
                <thead class="table-light text-center">
                <tr>
                    <th style="width: 15%;">Size</th>
                    <th style="width: 20%;">SKU</th>
                    <th style="width: 15%;">Price</th>
                    <th style="width: 15%;">Stock</th>
                    <th style="width: 15%;">Sort</th>
                    <th style="width: 15%;">Actions</th>
                </tr>
                </thead>
                <tbody>
                @foreach($product['attributes'] as $attribute)
                    <input type="hidden" name="attrId[]" value="{{ $attribute['id'] }}">
                    <tr class="text-center">
                        <td>{{ $attribute['size'] }}</td>
                        <td>{{ $attribute['sku'] }}</td>
                        <td>
                            <input type="number" name="update_price[]"
                                   value="{{ $attribute['price'] }}"
                                   class="form-control text-center" required>
                        </td>
                        <td>
                            <input type="number" name="update_stock[]"
                                   value="{{ $attribute['stock'] }}"
                                   class="form-control text-center" required>
                        </td>
                        <td>
                            <input type="number" name="update_sort[]"
                                   value="{{ $attribute['sort'] }}"
                                   class="form-control text-center" required>
                        </td>
                        <td>
                            @if($attribute['status'] == 1)
                                <a class="updateAttributeStatus text-primary me-2"
                                   id="attribute-{{ $attribute['id'] }}"
                                   data-attribute-id="{{ $attribute['id'] }}"
                                   href="javascript:void(0)">
                                    <i class="fa fa-toggle-on" data-status="Active"></i>
                                </a>
                            @else
                                <a class="updateAttributeStatus text-secondary me-2"
                                   id="attribute-{{ $attribute['id'] }}"
                                   data-attribute-id="{{ $attribute['id'] }}"
                                   href="javascript:void(0)">
                                    <i class="fa fa-toggle-off" data-status="Inactive"></i>
                                </a>
                            @endif
                            <a title="Delete Attribute" href="javascript:void(0)"
                               class="confirmDelete text-danger" data-module="product-attribute"
                               data-id="{{ $attribute['id'] }}">
                                <i class="fa fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                @endforeach
                </tbody>
            </table>
        </div>
    </div>
@endif
```
### Краткое содержание
К концу этой части администратор теперь может:
- Динамическое добавление нескольких атрибутов продукта с помощью jQuery
- Отправка и проверка атрибутов с помощью уникальных проверок артикула/размера
- Просмотр добавленных атрибутов прямо внутри формы продукта
# Что дальше?
В [следующей части](39.md) мы реализуем функциональность «Активно/Неактивно» и «Удалить» для атрибутов продукта.

[Оглавление](../README.md)
