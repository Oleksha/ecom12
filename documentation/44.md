# Часть 44. Скрытие/отображение столбцов в таблицах данных (категории и товары)
В этой части мы дополняем списки категорий и товаров функцией скрытия/отображения видимости с помощью расширения DataTable ColVis. Настройки каждого администратора сохраняются и автоматически восстанавливаются при последующих посещениях, что значительно упрощает работу администратора.
## Шаг 1. Миграция для настроек столбцов. 
Добавьте поле **hidden_columns** в миграцию **create_column_preferences_table**.
```php
Schema::create('column_preferences', function (Blueprint $table) {
    $table->id();
    $table->unsignedBigInteger('admin_id');
    $table->string('table_name');
    $table->text('column_order')->nullable(); // в формате JSON
    $table->text('hidden_columns')->nullable(); // в формате JSON
    $table->timestamps();
});
```
Выполните команду
```
php artisan миграция
```
## Шаг 2. Настройка модели
Исправьте изменяемые поля в модели **ColumnPreference**.
```php
protected $fillable = ['admin_id', 'table_name', 'column_order', 'hidden_columns'];
```
## Шаг 3. Создать маршрут:
```php
// Save Column Visibility
Route::post('save-column-visibility', [AdminController::class, 'saveColumnVisibility']);
```
## Шаг 4. Добавьте метод видимости saveColumn в AdminController.
```php
public function saveColumnVisibility(Request $request)
{
    $userId = Auth::guard('admin')->id();
    $tableName = $request->table_key;
    if (!$tableName) {
        return response()->json(['status' => 'error', 'message' => 'Table key is required'], 400);
    }
    ColumnPreference::updateOrCreate(
        ['admin_id' => $userId, 'table_name' => $tableName],
        [
            'column_order' => json_encode($request->column_order),
            'hidden_columns' => json_encode($request->hidden_columns)
        ]
    );
    return response()->json(['status' => 'success']);
}
```
## Шаг 5. Загрузите настройки в контроллер
- **CategoryController**
```php
public function index()
{
    Session::put('page', 'categories');
    $result = $this->categoryService->categories();
    if ($result['status'] == 'error') {
        return redirect('admin/dashboard')->with('error_message', $result['message']);
    }
    $categories = $result['categories'];
    $categoriesModule = $result['categoriesModule'];

    $columnPrefs = ColumnPreference::where('admin_id', Auth::guard('admin')->id())
        ->where('table_name', 'categories')
        ->first();

    $categoriesSavedOrder = $columnPrefs ? json_decode($columnPrefs->column_order, true) : null;
    $categoriesHiddenCols = $columnPrefs ? json_decode($columnPrefs->hidden_columns, []) : null;

    return view('admin.categories.index')
        ->with(compact(
            'categories',
            'categoriesModule',
            'categoriesSavedOrder',
            'categoriesHiddenCols'));
}
```
- **ProductController**
```php
public function index()
{
    Session::put('page', 'products');
    $result = $this->productService->products();
    if ($result['status'] == 'error') {
        return redirect('admin/dashboard')->with('error_message', $result['message']);
    }

    $products = $result['products'];
    $productsModule = $result['productsModule'];
    
    $columnPrefs = ColumnPreference::where('admin_id', Auth::guard('admin')->id())
        ->where('table_name', 'products')
        ->first();

    $productsSavedOrder = $columnPrefs ? json_decode($columnPrefs->column_order, true) : null;
    $productsHiddenCols = $columnPrefs ? json_decode($columnPrefs->hidden_columns, []) : null;
    
    return view('admin.products.index')
        ->with(compact(
            'products',
            'productsModule', 
            'productsSavedOrder', 
            'productsHiddenCols'));
}
```
## Шаг 6. JavaScript для сохранения настроек (общий файл)
```js
<script>
    $(document).ready(function() {
        const tablesConfig = [
            {
                id: 'categories',
                savedOrder: {!! json_encode($categoriesSavedOrder ?? null) !!},
                hiddenCols: {!! json_encode($categoriesHiddenCols ?? []) !!},
                tableName: 'categories'
            },
            {
                id: 'products',
                savedOrder: {!! json_encode($productsSavedOrder ?? null) !!},
                hiddenCols: {!! json_encode($productsHiddenCols ?? []) !!},
                tableName: 'products'
            }
        ];
        tablesConfig.forEach(config => {
            const tableElement = $('#' + config.id);
            if (tableElement.length > 0) {
                let dataTable = tableElement.DataTable({
                    order: [[0, 'desc']],
                    colReorder: {
                        order: config.savedOrder
                    },
                    dom: 'Bfrtip',
                    buttons: ['colvis'],
                    columnDefs: config.hiddenCols.map(index => ({
                        targets: parseInt(index),
                        visible: false
                    }))
                });
                dataTable.on('column-reorder', function () {
                    savePreferences(config.tableName, dataTable.colReorder.order(), getHiddenColumnIndexes(dataTable));
                });
                dataTable.on('column-visibility.dt', function () {
                    savePreferences(config.tableName, dataTable.colReorder.order(), getHiddenColumnIndexes(dataTable));
                });
            }
        });

        function getHiddenColumnIndexes(dataTable) {
            let hidden = [];
            dataTable.columns().every(function (index) {
                if (!this.visible()) hidden.push(index);
            });
            return hidden;
        }

        function savePreferences(tableName, columnOrder, hiddenCols) {
            $.ajax({
                url: "{{ url('admin/save-column-visibility') }}",
                type: "POST",
                data: {
                    _token: "{{ csrf_token() }}",
                    table_key: tableName,
                    column_order: columnOrder,
                    hidden_columns: hiddenCols
                },
                success: function (response) {
                    console.log('Сохранены настройки для ' + tableName + ': ', response);
                }
            });
        }
    });
</script>
```
## Шаг 7. Включите необходимые скрипты DataTables
Важно: обязательно включите эти скрипты в файл макета или в конкретное представление, в котором отображаются таблицы данных.
```html
<!-- Datatable CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<!-- ColReorder CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/colreorder/1.6.2/css/colReorder.dataTables.min.css">
<!-- Button CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<!-- Datatable JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<!-- ColReorder JS -->
<script src="https://cdn.datatables.net/colreorder/1.6.2/js/dataTables.colReorder.min.js"></script>
<!-- Buttons Extension -->
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>
```
Окончательный результат
- Порядок столбцов сохраняется для каждого администратора в каждой таблице.
- Скрытые столбцы, запоминающиеся при посещениях
- Работает с модулями «Категории» и «Товары».
# Что дальше?
В [следующей части](45.md) мы начнем работать над модулем брендов, который позволит администраторам назначать каждому продукту определенный бренд для лучшей фильтрации и управления.

[Оглавление](../README.md)
