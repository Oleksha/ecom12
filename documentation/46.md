# Часть 46. Модуль брендов (II): список в панели администратора, контроль доступа, переключение статуса и удаление
В этой части мы продолжим работу над модулем брендов и сосредоточимся на отображении брендов в панели администратора с помощью DataTables.

Мы также добавляем управление доступом на основе ролей для администратора/субадминистратора и реализуем функцию переключения статуса (активный/неактивный) и удаления бренда с использованием маршрутов ресурсов AJAX и Laravel.
## Шаг 1. Определить маршрут ресурса
Добавьте следующий маршрут ресурса в группу промежуточного программного обеспечения администратора в файле routes/web.php для обработки всех операций, связанных с брендом:
```php
// Бренды
Route::resource('brands', BrandController::class);
```
Это автоматически настраивает стандартные маршруты для индексации, создания, хранения, отображения, редактирования, обновления и уничтожения.
## Шаг 2. Создание BrandService
Для обработки всей бизнес-логики, связанной с брендами, создайте специальный класс сервиса по адресу: **app/Services/Admin/BrandService.php**

Эта служба будет отвечать за такие операции, как извлечение, создание, обновление, удаление брендов и обработка разрешений.
## Шаг 3. Внедрение BrandService в BrandController
Обновите файл **BrandController.php** и добавьте **BrandService** через конструктор:
```php
public function __construct(
    protected BrandService $brandService,
) {}
```
## Шаг 4. Реализуйте метод brands() в BrandService
Откройте **BrandService.php** и определите метод для возврата всех брендов и обработки разрешений администратора/субадминистратора:
```php
namespace App\Services\Admin;

use App\Models\AdminsRole;
use App\Models\Brand;
use Illuminate\Support\Facades\Auth;

class BrandService
{
    public function brands(): array
    {
        $brands = Brand::get();
        $admin = Auth::guard('admin')->user();
        $status = 'success';
        $message = '';
        $productsModule = [];
        // Admin has full access
        if ($admin->role == 'admin') {
            $brandsModule = [
                'view_access' => 1,
                'edit_access' => 1,
                'full_access' => 1,
            ];
        } else {
            $brandsModuleCount = AdminsRole::where([
                'subadmin_id' => $admin->id,
                'module' => 'brands',
            ])->count();
            if ($brandsModuleCount > 0) {
                $status = 'error';
                $message = 'This feature is restricted for you.';
            } else {
                $brandsModule = AdminsRole::where([
                    'subadmin_id' => $admin->id,
                    'module' => 'brands',
                ])->first()->toArray();
            }
        }
        return [
            'brands' => $brands,
            'brandsModule' => $brandsModule,
            'status' => $status,
            'message' => $message,
        ];
    }
}
```
## Шаг 5. Обновите метод index() в BrandController. 
Используйте внедренную службу для получения брендов и разрешений:
```php
public function index()
{
    Session::put('page', 'brands');
    $result = $this->brandService->brands();
    if ($result['status'] === 'error') {
        return redirect('admin/dashboard')->with('error_message', $result['message']);
    }
    return view('admin.brands.index', [
        'brands' => $result['brands'],
        'brandsModule' => $result['brandsModule'],
    ]);
}
```
## Шаг 6. Создайте index.blade.php для просмотра брендов
Внутри **/resources/views/admin/brands/index.blade.php** отобразите все бренды в таблице.
Вот содержимое blade-файла с использованием AdminLTE + DataTables:
```html
<table id="brands" class="table table-bordered table-striped">
    <thead>
    <tr>
        <th>ID</th>
        <th>Наименование</th>
        <th>URL</th>
        <th>Created On</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    @foreach($brands as $brand)
        <tr>
            <td>{{ $brand->id }}</td>
            <td>{{ $brand->name }}</td>
            <td>{{ $brand->url }}</td>
            <td>{{ $brand->created_at->format('F j, Y, g:i a') }}</td>
            <td>
                @if($brandsModule['edit_access'] == 1 || $brandsModule['full_access'] == 1)
                    @if($brand->status == 1)
                        <a class="updateBrandStatus me-2"
                           data-brand-id="{{ $brand->id }}"
                           style="color: #3f6ed3" href="javascript:void(0)"><i class="fas fa-toggle-on" data-status="Active"></i></a>
                    @else
                        <a class="updateBrandStatus me-2"
                           data-brand-id="{{ $brand->id }}"
                           style="color: grey" href="javascript:void(0)"><i class="fas fa-toggle-off" data-status="Inactive"></i></a>
                    @endif
                    <a class="me-2" href="{{ route('brands.edit', $brand->id) }}"><i class="fas fa-edit"></i></a>
                    @if($brandsModule['full_access'] == 1)
                        <form action="{{ route('brands.destroy', $brand->id) }}"
                              method="POST" style="display: inline-block">
                            @csrf
                            @method('DELETE')
                            <button class="confirmDelete"
                                    name="Brand"
                                    title="DeleteCategory"
                                    type="button"
                                    data-module="brands"
                                    data-id="{{ $brand->id }}"
                                    style="border: none; background: none; color: #3f6ed3">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    @endif
                @endif
            </td>
        </tr>
    @endforeach
    </tbody>
</table>
```
**Инициализация DataTable**

В вашем файле **scripts.blade.php** или отдельном разделе скрипта:
```js
<script>
    $(document).ready(function() {
        $('#subadmins').DataTable();
        $('#brands').DataTable();

        // Оставшийся код без изменения
    });
</script>
```
Теперь мы улучшим модуль брендов, реализовав следующие функции:
- Изменить статус бренда (активный/неактивный)
- Удалить бренд

Эти функции необходимы для поддержания чистоты и управляемости данных о бренде в вашей панели администратора.

Обновите **brands/index.blade.php** для отображения значков статуса Сначала давайте обновим представление Blade для отображения значков статуса с помощью Font Awesome:
```html
@if($brand->status == 1)
    <a class="updateBrandStatus me-2"
       data-brand-id="{{ $brand->id }}"
       style="color: #3f6ed3" href="javascript:void(0)"><i class="fas fa-toggle-on" data-status="Active"></i></a>
@else
    <a class="updateBrandStatus me-2"
       data-brand-id="{{ $brand->id }}"
       style="color: grey" href="javascript:void(0)"><i class="fas fa-toggle-off" data-status="Inactive"></i></a>
@endif
```
### Добавьте логику jQuery в custom.js для обновления статуса AJAX
Затем добавьте код jQuery для обработки переключения статуса без обновления страницы:
```js
// Update Brand Status
$(document).on("click", ".updateBrandStatus", function(){
    let status = $(this).children('i').data('status');
    let brand_id = $(this).data('brand-id');
    $.ajax({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        },
        type: "POST",
        url: "/admin/update-brand-status",
        data: { status: status, brand_id: brand_id},
        success: function (response) {
            if (response['status'] === 0) {
                $("a[data-brand-id='" + brand_id + "']").html("<i class='fa fa-toggle-off' style='color: gray' data-status='Inctive'></i>");
            } else if (response['status'] === 1) {
                $("a[data-brand-id='" + brand_id + "']").html("<i class='fa fa-toggle-on' style='color: #3f6ed3' data-status='Active'></i>");
            }
        },
        error: function () {
            alert("Error");
        }
    });
});
```
### Создать маршрут для обновления статуса
Добавьте следующий маршрут POST в файл web.php:
```php
Route::post('update-brand-status', [BrandController::class, 'updateBrandStatus']);
```
### Создайте метод updateBrandStatus в BrandController.
В BrandController определите метод получения данных AJAX:
```php
public function updateBrandStatus(Request $request)
{
    if (request()->ajax()) {
        $data = $request->all();
        $status = $this->brandService->updateBrandStatus($data);
        return response()->json(['status' => $status, 'brand_id' => $data['brand_id']]);
    }
}
```
### Создайте метод updateBrandStatus в BrandService
Теперь в вашем **BrandService** добавьте логику для обновления статуса бренда в базе данных:
```php
public function updateBrandStatus($data): int
{
    $status = ($data['status'] == 'Active') ? 0 : 1;
    Brand::where('id', $data['brand_id'])->update(['status' => $status]);
    return $status;
}
```
## Функция удаления бренда
### Добавить значок удаления в вид
Обновите **brands/index.blade.php**, включив в него удаление на основе формы с помощью метода DELETE рядом с каждым брендом:
```html
<form action="{{ route('brands.destroy', $brand->id) }}"
      method="POST" style="display: inline-block">
    @csrf
    @method('DELETE')
    <button class="confirmDelete" name="Brand" title="DeleteCategory" type="button"
            data-module="brands" data-id="{{ $brand->id }}"
            style="border: none; background: none; color: #3f6ed3">
        <i class="fas fa-trash"></i>
    </button>
</form>
```
### Обновление метода Destroy в BrandController
В контроллере вызовите функцию **deleteBrand** из **CategoryService** для обработки запроса на удаление:
```php
public function destroy(string $id)
{
    $result = $this->brandService->deleteBrand($id);
    return redirect()->back()->with('success_message', $result['message']);
}
```
### Обработка удаления в BrandService
Добавьте логику удаления в **BrandService** для окончательного удаления бренда:
```php
public function deleteBrand(string $id): array
{
    Brand::where('id', $id)->delete();
    $message = 'Brand deleted successfully.';
    return ['message' => $message];
}
```
# Что дальше?
В [следующей части](47.md) мы создадим административную панель URL для добавления и редактирования бренда, а также для загрузки изображений/логотипов и генерации удобных URL-адресов для каждого бренда.

[Оглавление](../README.md)
