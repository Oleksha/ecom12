# Часть 22. Модуль «Категории» (IV) | Добавить раскрывающийся список уровней категорий (3 уровня)
В этой части мы улучшим функцию добавления/редактирования категории, добавив раскрывающийся список «Родительская категория». Это позволит администратору выбрать существующую категорию в качестве родительской, что обеспечит поддержку подкатегорий глубиной до 3 уровней.
## Шаг 1. Добавить рекурсивную связь в ```Category.php```
Мы определим рекурсивное отношение для динамического извлечения подкатегорий:
```php
public function subcategories(): HasMany
{
    return $this->hasMany(Category::class, 'parent_id')
        ->where('status', 1);
}
```
Это позволит нам получить доступ к подкатегориям и их дочерним элементам во вложенной структуре.
## Шаг 2. Создайте статический метод ```getCategories()``` в ```Category.php```
Этот метод извлекает категории с вложенными подкатегориями глубиной до 3 уровней. Он также поддерживает фильтрацию по контексту (администратор или фронт):
```php
public static function getCategories($type): array
{
    $getCategories = Category::with(['subcategories.subcategories'])
        ->whereNull('parent_id')
        ->where('status', 1);
    if ($type == 'Front') {
        $getCategories = $getCategories->where('menu_status', 1);
    }
    return $getCategories->get()->toArray();
}
```
Если тип — Front, извлекаются только категории с menu_status = 1 (т.е. категории, видимые в меню внешнего интерфейса).
## Шаг 3. Обновление контроллера категорий
Мы обновим методы контроллера для передачи извлеченных данных категории в представление.

**Обновить функцию create**:
```php
public function create()
{
    $title = 'Добавить категорию';
    $category = new Category();
    $getCategories = Category::getCategories('Admin');
    return view('admin.categories.add_edit_category', 
        compact('title', 'getCategories', 'category'));
}
```
**Обновить функцию edit**:
```php
public function edit(string $id)
{
    $title = 'Редактировать категорию';
    $category = Category::findOrFail($id);
    $getCategories = Category::getCategories('Admin');
    return view('admin.categories.add_edit_category', 
        compact('title', 'category', 'getCategories'));
}
```
**Обновить функцию update**:
```php
public function update(Request $request, string $id)
{
    $request->merge(['id' => $id]); // Ensure `addEditCategory` handles both Add/Edit
    $message = $this->categoryService->addEditCategory($request);
    return redirect()->route('categories.index')
        ->with('success_message', $message);
}
```
## Шаг 4. Обновление ```add_edit_category.blade.php```
Мы добавим раскрывающийся список «Родительская категория» в форму категории, чтобы позволить выбрать существующую категорию в качестве родительской:
```html
<div class="mb-3">
    <label for="parent_id" class="form-label">
        Category Level (Parent Category)*
    </label>
    <select name="parent_id" class="form-control" id="parent_id">
        <option value="">Select</option>
        <option value="" @if(is_null($category->parent_id)) selected @endif>Main Category</option>
        @foreach($getCategories as $cat)
            <option value="{{ $cat['id'] }}" @if(isset($category['parent_id']) && $category['parent_id'] == $cat['id']) selected @endif>{{ $cat['name'] }}</option>
            @if(!empty($cat['subcategories']))
                @foreach($cat['subcategories'] as $subcat)
                    <option value="{{ $subcat['id'] }}" @if(isset($category['parent_id']) && $category['parent_id'] == $subcat['id']) selected @endif>
                        &nbsp;&nbsp;&nbsp;&nbsp;&raquo;&raquo;{{ $subcat['name'] }}
                    </option>
                    @if(!empty($subcat['subcategories']))
                        @foreach($subcat['subcategories'] as $subsubcat)
                            <option value="{{ $subsubcat['id'] }}" @if(isset($category['parent_id']) && $category['parent_id'] == $subsubcat['id']) selected @endif>
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&raquo;&raquo;{{ $subsubcat['name'] }}
                            </option>
                        @endforeach
                    @endif
                @endforeach
            @endif
        @endforeach
    </select>
</div>
```
## Шаг 5. Обновите метод ```addEditCategory()``` в ```CategoryService.php```.
Чтобы сохранить выбранную родительскую категорию, обновите метод для сохранения ```parent_id```:
```php
// Save parent_id (null for Main Category)
$category->parent_id = !empty($data['parent_id']) ? $data['parent_id'] : null;
```
Это гарантирует правильное сохранение в базе данных как основных категорий, так и подкатегорий.
К концу этой части вы сможете:
- Создавайте основные категории и вложенные подкатегории глубиной до 3 уровней.
- Отображать выбранную родительскую категорию во время редактирования
- Организуйте структуру категорий для лучшего пользовательского опыта
# Что дальше?
В [следующей части](23.md) мы добавим проверку в форму «Добавить/редактировать категорию», чтобы гарантировать чистый ввод данных.

[Оглавление](../README.md)
