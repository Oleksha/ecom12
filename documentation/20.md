# Часть 20. Модуль «Категории» (II) | Отображение категорий в панели администратора

В этой части мы продолжим работу над модулем «Категории» и сосредоточимся на отображении категорий в панели администратора с помощью DataTables.

Мы также будем управлять контролем доступа администратора/субадминистратора с помощью таблицы AdminsRole.

## Шаг 1. Определяем маршрут

Добавьте следующий маршрут ресурса в группу промежуточного программного обеспечения администратора в web.php для обработки всех операций, связанных с категориями:
```
Route::resource('categories', CategoryController::class);
```
Это автоматически настроит стандартные маршруты для индексации, создания, хранения, отображения, редактирования, обновления и уничтожения.
## Шаг 2. Определить отношение родительской категории
В модели «Категория» определите отношение для извлечения родительской категории заданной категории:
```
public function parent_category(): HasOne
{
    return $this->hasOne(Category::class, 'id', 'parent_id')
        ->select('id', 'name', 'url')
        ->where('status', 1)
        ->orderBy('id', 'ASC');
}
```
Эта связь позволяет извлекать подкатегории и отображать соответствующее имя родительской категории.

## Шаг 3. Создание сервиса категорий.

Для обработки всей бизнес-логики, связанной с категориями, создайте специальный файл службы в следующем месте:
```
/app/Services/Admin/CategoryService.php
```
Эта служба будет отвечать за такие операции, как извлечение, создание, обновление и удаление категорий, а также за обработку разрешений.

## Шаг 4. Внедрение ```CategoryService``` в контроллер через конструктор

Обновите файл ```CategoryController.php``` и внедрите ```CategoryService```, используя внедрение зависимостей на основе конструктора:
```
use App\Http\Controllers\Controller;
use App\Services\Admin\CategoryService;
use Illuminate\Http\Request;

class CategoryController extends Controller
{
    public function __construct(
        protected CategoryService $categoryService,
    )
    {}

    ...
}
```
## Шаг 5. Реализуйте метод ```categories()``` в ```CategoryService```
Откройте ```CategoryService.php``` и определите метод ```categories()``` для возврата всех категорий и обработки разрешений администратора/субадминистратора:
```
namespace App\Services\Admin;

use App\Models\AdminsRole;
use App\Models\Category;
use Illuminate\Support\Facades\Auth;

class CategoryService
{
    public function categories()
    {
        $categories = Category::with('parent_category')->get();
        $admin = Auth::guard('admin')->user();
        $status = 'success';
        $message = '';
        $categoriesModule = [];

        // Admin has full access
        if ($admin->role == 'admin') {
            $categoriesModule = [
                'view_access' => 1,
                'edit_access' => 1,
                'full_access' => 1,
            ];
        } else {
            $categoriesModuleCount = AdminsRole::where([
                'subadmin_id', $admin->id,
                'module', 'categories'
            ])->count();
            if ($categoriesModuleCount == 0) {
                $status = 'error';
                $message = 'This feature is restricted for you!';
            } else {
                $categoriesModule = AdminsRole::where([
                    'subadmin_id' => $admin->id,
                    'module' => 'categories'
                ])->first()->toArray();
            }
        }
        return [
            'categories' => $categories,
            'categoriesModule' => $categoriesModule,
            'status' => $status,
            'message' => $message,
        ];
    }
}
```
## Шаг 6. Обновление метода ```index()``` в ```CategoryController```
Используйте внедренную службу для получения категорий и разрешений:
```
public function index()
{
    Session::put('page', 'categories');
    $result = $this->categoryService->categories();
    if ($result['status'] == 'error') {
        return redirect('admin/dashboard')->with('error_message', $result['message']);
    }
    return view('admin.categories.index', [
        'categories' => $result['categories'],
        'categoriesModule' => $result['categoriesModule'],
    ]);
}
```
## Шаг 7. Создайте ```index.blade.php``` для просмотра категорий

Внутри ```/resources/views/admin/categories/index.blade.php``` отобразите все категории в таблице.
```
<table id="categories" class="table table-bordered table-striped">
    <thead>
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Parent Category</th>
        <th>URL</th>
        <th>Created On</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    @foreach($categories as $category)
        <tr>
            <td>{{ $category->id }}</td>
            <td>{{ $category->name }}</td>
            <td>{{ $category->parent_category->name ?? '' }}</td>
            <td>{{ $category->url }}</td>
            <td>{{ $category->created_at->format('F j, Y, g:i a') }}</td>
            <td>
                <!-- Action(Enable/Disable, Edit, Delete) will be added here -->
            </td>
        </tr>
    @endforeach
    </tbody>
</table>
```
## Шаг 8. Инициализируйте ```DataTables``` в ```scripts.blade.php```

Включите необходимые ссылки ```CDN``` и инициализируйте ```DataTables``` в файле ```scripts.blade.php```:
```
<!-- Datatable -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script>
    $(document).ready(function(){
        $("#categories").DataTable();
    });
</script>
```
Вы также можете использовать его для других модулей, таких как:
```
$("#subadmins").DataTable();
```
# Что дальше?

В [следующей части](21.md) мы поработаем над включением/отключением категорий и реализацией функции удаления из панели администратора.

[Оглавление](../README.md)
