# Часть 26. Модуль «Категории» (VIII) | Ролевой доступ для субадминистраторов
В этой части мы завершим работу над модулем «Категории», реализовав функционал «Роли и разрешения». Это позволит администратору назначать субадминистраторам определённые разрешения (просмотр/редактирование/полный доступ) для управления категориями.
## Шаг 1. Обновите функцию ```categories()``` в CategoryService
Мы обновляем функцию ```categories()``` для реализации доступа на основе ролей:
- Если вошедший в систему пользователь является администратором, предоставляется полный доступ.
- Если пользователь является субадминистратором, мы проверяем таблицу ```AdminsRole``` на предмет назначенных разрешений в модуле «категории».
```
public function categories(): array
{
    $categories = Category::with('parent_category')->get();
    $admin = Auth::guard('admin')->user();
    $categoriesModuleCount = AdminsRole::where([
        'subadmin_id' => $admin->id,
        'module' => 'categories'
    ])->count();
    $status = 'success';
    $message = '';
    $categoriesModule = [];

    // Admin has full access
    if ($admin->role == 'admin') {
        $categoriesModule = [
            'view_access' => 1,
            'edit_access' => 1,
            'full_access' => 1,
        ];
    } elseif ($categoriesModuleCount == 0) {
        $status = 'error';
        $message = 'Эта функция ограничена для вас!';
    } else {
        $categoriesModule = AdminsRole::where([
            'subadmin_id' => $admin->id,
            'module' => 'categories'
        ])->first()->toArray();
    }
    return [
        'categories' => $categories,
        'categoriesModule' => $categoriesModule,
        'status' => $status,
        'message' => $message,
    ];
}
```
## Шаг 2. Обновите функцию index() в CategoryController
Мы обновляем метод index(), чтобы использовать измененный метод службы и обрабатывать перенаправление на основе доступа:
```
public function index()
{
    Session::put('page', 'categories');
    $result = $this->categoryService->categories();
    if ($result['status'] == 'error') {
        return redirect('admin/dashboard')->with('error_message', $result['message']);
    }
    return view('admin.categories.index', [
        'categories' => $result['categories'],
        'categoriesModule' => $result['categoriesModule'],
    ]);
}
```
## Шаг 3. Обновите categories/index.blade.php для отображения/скрытия элементов пользовательского интерфейса на основе разрешений.

Мы добавляем условные операторы для ограничения доступа к действиям «Добавить», «Редактировать», «Изменить статус» и «Удалить» в зависимости от назначенной роли:
**Кнопка Добавить**
```
@if($categoriesModule['edit_access'] == 1 || $categoriesModule['full_access'] == 1)
    <a style="max-width: 250px; float:right; display: inline-block;"
       href="{{ route('categories.create') }}"
       class="btn btn-block btn-primary">
        Добавить категорию
    </a>
@endif
```
**Действия с категориями**
```
@if($categoriesModule['edit_access'] == 1 || $categoriesModule['full_access'] == 1)
    @if($category->status == 1)
        <a class="updateCategoryStatus me-2"
           data-category-id="{{ $category->id }}"
           style="color: #3f6ed3" href="javascript:void(0)"><i class="fas fa-toggle-on" data-status="Active"></i></a>
    @else
        <a class="updateCategoryStatus me-2"
           data-category-id="{{ $category->id }}"
           style="color: grey" href="javascript:void(0)"><i class="fas fa-toggle-off" data-status="Inactive"></i></a>
    @endif
    <a class="me-2" href="{{ route('categories.edit', $category->id) }}"><i class="fas fa-edit"></i></a>
    @if($categoriesModule['full_access'] == 1)
        <form action="{{ route('categories.destroy', $category->id) }}"
              method="POST" style="display: inline-block"
              onsubmit="return confirm('Are you sure to delete this category?')">
            @csrf
            @method('DELETE')
            <button type="submit" style="border: none; background: none; color: #3f6ed3"><i class="fas fa-trash"></i></button>
        </form>
    @endif
@endif
```
## Шаг 4. Обновите dashboard.blade.php для обработки флэш-сообщений.
Мы показываем оповещения об успешном выполнении и ошибках на основе сообщений сеанса при перенаправлении субадминистраторов:
```
@if(Session::has('success_message'))
    <div class="alert alert-success alert-dismissible fade show m-3" role="alert">
        <strong>Success: </strong>{{ Session::get('success_message') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    @endif
    @if(Session::has('error_message'))
    <div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
        <strong>Success: </strong>{{ Session::get('error_message') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
@endif
```
Модуль «Категории» теперь полностью интегрирован с управлением доступом на основе ролей (RBAC) для субадминистраторов. Субадминистраторы смогут выполнять только те действия, которые им разрешены и определены администратором.
# Что дальше?
В [следующей части](27.md) прежде чем перейти к модулю «Продукты», мы:
- Замените стандартные оповещения JavaScript красивыми модальными окнами SweetAlert.
- Создайте общую функцию удаления jQuery, которую можно использовать повторно во всех модулях.

[Оглавление](../README.md)
