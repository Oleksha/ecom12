# Часть 41. Исправление проблем с Dropzone для загрузки изображений и видео продуктов
В этой части мы решаем различные проблемы, связанные с Dropzone, связанные с загрузкой и удалением:
- Основное изображение продукта
- Альтернативные изображения продукта
- Видео о продукте

Мы решим такие проблемы, как обработка ошибок, удаление файлов и очистка на стороне сервера, чтобы сделать Dropzone полностью функциональным и надежным.
## Шаг 1. Исправление: ошибка в зоне перетаскивания основного изображения продукта (проблема с оповещением о проверке)
**Проблема:** Загрузка нескольких изображений вызывает постоянные оповещения JavaScript. Вместо этого показывайте встроенные сообщения об ошибках.
**Решение:** Чтобы решить эту проблему, мы отобразим ошибку на странице вместо отображения предупреждения JavaScript.

Заменить скрипт основной зоны размещения изображений в scripts.blade.php:
```js
// Main Image Dropzone
let mainImageDropzone = new Dropzone('#mainImageDropzone', {
    url: "{{ route('product.upload.image') }}",
    maxFiles: 1,
    acceptedFiles: "image/*",
    maxFilesize: 0.5,
    addRemoveLinks: true,
    dictDefaultMessage: 'Перетащите изображение продукта или щелкните, чтобы загрузить',
    headers: {
        'X-CSRF-TOKEN': "{{ csrf_token() }}"
    },
    success: function (file, response) {
        document.getElementById('main_image_hidden').value = response.fileName;
    },
    error: function (file, message) {
        if(!file.alreadyRejected) {
            file.alreadyRejected = true;
            // Показываем сообщение об ошибке в контейнере вместо использования alert()
            let errorContainer = document.getElementById('mainImageDropzoneError');
            if (errorContainer) {
                errorContainer.innerText = typeof message === 'string' ? message : message.message;
                errorContainer.style.display = 'block';
                // Скрываем через 4 секунды
                setTimeout(() => {
                    errorContainer.style.display = 'none';
                }, 4000);
            }
        }
        this.removeFile(file);
    },
    init: function () {
        this.on('maxfilesexceeded', function (file) {
            this.rmoveAllFiles();
            this.addFile(file);
        });
    }
});
```
Добавьте это в HTML, чтобы отобразить ошибку:
```html
<div id="mainImageDropzoneError" style="color: red; display: none;"></div>
```
## Шаг 2. Исправление: удаление основного файла изображения продукта из папки.
**Проблема**: Изображение остается в папке даже если его удалить из Dropzone UI.

Обновленная конфигурация Dropzone:
```js
// Product Main Image Dropzone
let mainImageDropzone = new Dropzone('#mainImageDropzone', {
    url: "{{ route('product.upload.image') }}",
    maxFiles: 1,
    acceptedFiles: "image/*",
    maxFilesize: 0.5,
    addRemoveLinks: true,
    dictDefaultMessage: 'Перетащите изображение продукта или щелкните, чтобы загрузить',
    headers: {
        'X-CSRF-TOKEN': "{{ csrf_token() }}"
    },
    success: function (file, response) {
        // Сохраняем имя файла для ссылки на него при удалении.
        file.uploadedFileName = response.fileName;
        document.getElementById('main_image_hidden').value = response.fileName;
    },
    removedfile: function (file) {
        // Необязательно: проверяем, был ли файл успешно загружен.
        if (file.uploadedFileName) {
            $.ajax({
                url: "{{ route('admin.product.delete-image') }}", // При необходимости скорректируйте маршрут.
                type: "POST",
                data: {
                    _token: "{{ csrf_token() }}",
                    image: file.uploadedFileName
                },
                success: function (result) {
                    console.log("Основное изображение успешно удалено.");
                    // Очищаем скрытое поле, если изображение удалено.
                    document.getElementById("main_image_hidden").value = '';
                },
                error: function () {
                    console.log("Ошибка при удалении основного изображения.");
                }
            });
        }
        // Удаляем предварительный просмотр из Dropzone UI
        let previewElement = file.previewElement;
        if (previewElement !== null) {
            previewElement.parentNode.removeChild(previewElement);
        }
    },
    error: function (file, message) {
        if(!file.alreadyRejected) {
            file.alreadyRejected = true;
            // Показываем сообщение об ошибке в контейнере вместо использования alert()
            let errorContainer = document.getElementById('mainImageDropzoneError');
            if (errorContainer) {
                errorContainer.innerText = typeof message === 'string' ? message : message.message;
                errorContainer.style.display = 'block';
                // Скрываем через 4 секунды
                setTimeout(() => {
                    errorContainer.style.display = 'none';
                }, 4000);
            }
        }
        this.removeFile(file);
    },
    init: function () {
        this.on('maxfilesexceeded', function (file) {
            this.rmoveAllFiles();
            this.addFile(file);
        });
    }
});
```
**Добавьте этот маршрут в web.php**:
```php
Route::post('/product/delete-dropzone-image', [ProductController::class, 'deleteDropzoneImage'])->name('admin.product.delete-image');
```
**В ProductController.php**:
```php
public function deleteDropzoneImage(Request $request)
{
    $deleted = $this->productService->deleteDropzoneImage($request->image);
    return response()->json(['status' => $deleted ? 'deleted' : 'file_not_found'], $deleted ? 200 : 400);
}
```
**В ProductService.php**:
```php
public function deleteDropzoneImage(string $imageName): bool
{
    $imagePath = public_path('front/images/products/' . $imageName);
    return file_exists($imagePath) && unlink($imagePath);
}
```
## Шаг 3. Исправление: удаление альтернативных изображений продукта с сервера.
Обновленная конфигурация Dropzone для альтернативных образов:
```js
// Product Images Dropzone
let productImagesDropzone = new Dropzone('#productImagesDropzone', {
    url: "{{ route('product.upload.images') }}",
    maxFiles: 10,
    acceptedFiles: "image/*",
    parallelUploads: 10, // Добавьте эту строку, чтобы разрешить параллельные загрузки.
    uploadMultiple: false, // Оставьте это значение false, если вы не хотите отправлять все файлы одним запросом.
    maxFilesize: 0.5,
    addRemoveLinks: true,
    dictDefaultMessage: 'Перетащите изображения продукта или щелкните, чтобы загрузить',
    headers: {
        'X-CSRF-TOKEN': "{{ csrf_token() }}"
    },
    init: function () {
        this.on('success', function (file, response) {
            // Добавить имя файла в скрытое поле ввода
            let hiddenInput = document.getElementById('product_images_hidden');
            let currentValue = hiddenInput.value;
            if (currentValue === '') {
                hiddenInput.value = response.fileName;
            } else {
                hiddenInput.value = currentValue + ',' + response.fileName;
            }
            file.uploadedFileName = response.fileName;
        });
        this.on('removedfile', function (file) {
            if (file.uploadedFileName) {
                let hiddenInput = document.getElementById('product_images_hidden');
                let currentValue = hiddenInput.value;
                let files = currentValue.split(',');

                files = files.filter(name => name !== file.uploadedFileName);
                hiddenInput.value = files.join(',');
                // Необязательно: удалить файл с сервера.
                $.ajax({
                    url: "{{ route('product.delete.temp.image') }}",
                    type: "POST",
                    data: { filename: file.uploadedFileName },
                    headers: {
                        'X-CSRF-TOKEN': "{{ csrf_token() }}"
                    }
                });
            }
        });
    }
});
```
**Добавьте этот маршрут**:
```php
Route::post('product/delete-temp-image', [ProductController::class, 'deleteTempImage'])->name('product.delete.temp.image');
```
**В ProductController.php**:
```php
public function deleteTempImage(Request $request)
{
    $image_path = public_path('front/images/products/'.$request->filename);
    if (file_exists($image_path)) {
        unlink($image_path);
    }
}
```
## Шаг 4. Исправление: удаление видео продукта с сервера.
Конфигурация Dropzone для видео о продукте:
```js
// Product Video Dropzone
let productVideoDropzone = new Dropzone('#productVideoDropzone', {
    url: "{{ route('product.upload.video') }}",
    maxFiles: 1,
    acceptedFiles: "video/*",
    maxFilesize: 2,
    addRemoveLinks: true,
    dictDefaultMessage: 'Перетащите видео о продукте или нажмите, чтобы загрузить.',
    headers: {
        'X-CSRF-TOKEN': "{{ csrf_token() }}"
    },
    success: function (file, response) {
        document.getElementById('product_video_hidden').value = response.fileName;
        file.uploadedFileName = response.fileName;
    },
    removedfile: function (file) {
        if (file.uploadedFileName) {
            document.getElementById('product_video_hidden').value = '';
            $.ajax({
                url: "{{ route('product.delete.temp.video') }}",
                type: "POST",
                data: { filename: file.uploadedFileName },
                headers: { 'X-CSRF-TOKEN': "{{ csrf_token() }}" }
            });
        }
        let previewElement = file.previewElement;
        if (previewElement !== null) {
            previewElement.parentNode.removeChild(previewElement);
        }
    },
    init: function () {
        this.on('maxfilesexceeded', function (file) {
            this.rmoveAllFiles();
            this.addFile(file);
        });
    }
});
```
**Добавить маршрут**:
```php
Route::post('/products/delete-temp-video', [ProductController::class, 'deleteTempProductVideo'])->name('product.delete.temp.video');
```
**В ProductController.php**:
```php
public function deleteTempProductVideo(Request $request)
{
    $deleted = $this->productService->deleteDropzoneVideo($request->filename);
    return response()->json(['status' => $deleted ? 'deleted' : 'file_not_found'], $deleted ? 200 : 400);
}
```
**В ProductService.php**:
```php
public function deleteDropzoneVideo(string $videoName): bool
{
    $videoPath = public_path('front/videos/products/' . $videoName);
    return file_exists($videoPath) && unlink($videoPath);
}
```
Теперь все проблемы с загрузкой/удалением изображений и видео, связанные с Dropzone, успешно решены.
# Что дальше?
В [следующей части](42.md) мы продолжим писать код для нашего сайта.

[Оглавление](../README.md)
