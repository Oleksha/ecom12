# Часть 12. Смена пароля администратора (III) | Изменить пароль администратора
В этой части мы завершим функционал обновления пароля администратора.

Мы обновим пароль администратора и применим проверки Laravel в форме обновления пароля. Мы также будем корректно обрабатывать сообщения об успешном завершении и ошибках, чтобы предоставлять администратору обратную связь в режиме реального времени.
## Шаг 1. Обновите действие формы для обновления пароля.
Ранее мы создали форму обновления пароля, но она не выполняла никаких действий, поскольку мы ещё не обновляли пароль. Теперь, когда мы готовы обновить пароль, нам нужно определить правильное действие с помощью функции ```route()```. В ```update_password.blade.php```:
```
<form method="post" action="{{ route('admin.update-password.request') }}">
    @csrf
    <!-- Form field go here -->
</form>
```
Почему ```route()``` лучше:
- Более чистый и читаемый код
- Легко обслуживать при изменении маршрута
- Улучшает гибкость
## Шаг 2. Добавьте маршрут POST для обновления пароля.
Нам нужно определить POST-маршрут в файле ```web.php``` для обработки отправки формы. Этот маршрут будет указывать на функцию запроса ```updatePassword``` в ```AdminController``` и будет иметь имя ```admin.update-password.request```.
```
// Update Password Request
Route::post('update-password', [AdminController::class, 'update'])->name('admin.update-password.request');
```
Почему это важно:
- Именованные маршруты облегчают ссылку на маршрут в представлении.
- Чистая и структурированная конфигурация маршрута
## Шаг 3. Создайте функцию updatePassword в AdminService
Мы создадим функцию ```updatePassword``` в ```AdminService``` для обновления пароля администратора.

Сначала мы проверим правильность текущего пароля с помощью ```Hash::check()```.
- Если все верно, мы проверим, совпадает ли новый пароль с подтвержденным паролем.
- Если они совпадают, мы обновим пароль и отправим сообщение об успешном завершении.
- Если они не совпадают или текущий пароль неверный, мы вернем сообщение об ошибке.
```
public function updatePassword($data): array
{
    // Check if the Current Password is correct
    if (Hash::check($data['current_pwd'], Auth::guard('admin')->user()->password)) {
        // Check if new password and confirm password match
        if ($data['new_pwd'] == $data['confirm_pwd']) {
            Admin::where('email', Auth::guard('admin')->user()->email)
                ->update(['password' => Hash::make($data['new_pwd'])]);
            $status ="success";
            $message = 'Password has been updated successfully!';
        } else {
            $status = "error";
            $message = 'New Password and Confirm Password must match!';
        }
    } else {
        $status = "error";
        $message = 'Your Current Password is incorrect!';
    }
    return ['status' => $status, 'message' => $message];
}
```
Включите модель ```Admin``` в начало ```AdminService.php```:
```
use App\Models\Admin;
```
## Шаг 4. Создайте запрос пароля для проверки
Теперь мы создадим класс ```PasswordRequest```, используя следующую команду Artisan:
```
php artisan make:request Admin/PasswordRequest
```
Добавьте правила проверки и пользовательские сообщения об ошибках в ```PasswordRequest.php```:
```
public function rules(): array
{
    return [
        'current_pwd' => 'required|string|min:6',
        'new_pwd' => 'required|string|min:6|different:current_pwd',
        'confirm_pwd' => 'required|string|same:new_pwd',
    ];
}

public function messages(): array
{
    return [
        'current_pwd.required' => 'Current password is required.',
        'current_pwd.min' => 'Current password must be at least 6 characters.',
        'new_pwd.required' => 'New password is required.',
        'new_pwd.min' => 'New password must be at least 6 characters.',
        'new_pwd.different' => 'New password must be different from current password.',
        'confirm_pwd.required' => 'Confirm password is required.',
        'confirm_pwd.same' => 'Confirm password must match the new password.',
    ];
}
```
Разрешаем проверку формы
```
public function authorize(): bool
{
    return true;
}
```
## Шаг 5. Создать функцию запроса обновления пароля в AdminController
Мы создадим функцию запроса ```updatePassword``` в ```AdminController``` для обновления пароля администратора.

Мы уже внедрили ```AdminService``` в конструктор, поэтому вызовем его напрямую, используя ```$this->adminService```.

В зависимости от результата мы выведем сообщение об успешном выполнении или ошибке в ```AdminController.php```:
```
public function update(PasswordRequest $request)
{
    if ($request->isMethod('post')) {
        $data = $request->all();
        $pwdStatus = $this->adminService->updatePassword($data);
        if ($pwdStatus['status'] == 'success') {
            return redirect()->back()->with('success_message', $pwdStatus['message']);
        } else {
            return redirect()->back()->with('error_message', $pwdStatus['message']);
        }
    }
}
```
## Шаг 6. Обновите update_password.blade.php для отображения сообщений.
Сообщение об успешном выполнении или ошибке будет отображено непосредственно на странице формы ```update_password.blade.php```:
```
@if(Session::has('error_message'))
    <div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
        <strong>Error: </strong> {{ Session::get('error_message') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
@endif
@if(Session::has('success_message'))
    <div class="alert alert-success alert-dismissible fade show m-3" role="alert">
        <strong>Success: </strong> {{ Session::get('success_message') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
@endif
@foreach($errors->all() as $error)
    <div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
        <strong>Error! </strong> {!! $error !!}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
@endforeach
```
## Шаг 7. Включить модель администратора и запрос пароля в AdminController
Включите модель ```Admin``` и класс ```PasswordRequest``` в начало ```AdminController.php```:
```
use App\Http\Requests\Admin\PasswordRequest;
use App\Models\Admin;
```
Как это работает
- Если текущий пароль правильный, новый пароль обновляется.
- Если новый пароль и подтверждение пароля совпадают, обновление выполнено успешно.
- Если текущий пароль неверный или новый и подтвержденный пароль не совпадают, отображается сообщение об ошибке.
# Что дальше?
В [следующей части](13.md) мы продолжим разработку более продвинутых функций.

[Оглавление](../README.md)
