# Часть 14. Обновить данные администратора (II) | Добавить/удалить изображение администратора
В этой части мы продолжим работу над обновлением данных администратора, добавив функционал загрузки и удаления изображения профиля администратора.

Для загрузки изображений мы установим пакет Intervention, который позволяет изменять размер и сохранять изображения. Мы также реализуем функцию удаления текущего изображения администратора с помощью AJAX.

В этом видео вы узнаете, как:
- Установить пакет Intervention для обработки загрузки изображений
- Загрузите изображение администратора с проверкой с помощью пакета Intervention
- Отобразить загруженное изображение администратора в заголовке и разделе профиля.
- Удалить изображение профиля администратора с помощью AJAX
- Безопасное обновление данных администратора с надлежащей проверкой
## Шаг 1. Установить пакет вмешательства:
Мы установим пакет Intervention с помощью следующей команды Composer:
```
composer require intervention/image-laravel
```
Файл конфигурации можно скопировать в приложение с помощью следующей команды.
```
php artisan vendor:publish --provider="Intervention\Image\Laravel\ServiceProvider"
```
## Шаг 2. Обновите файл update_details.blade.php:
Мы обновим форму для обработки загрузки файлов и отображения текущего изображения администратора, если оно доступно.

Добавьте enctype="multipart/form-data" в форму:
```html
<form method="post" action="{{ route('admin.update-details.request') }}" enctype="multipart/form-data">
```
Отобразить текущее изображение администратора и предоставить возможность удаления:
```html
<div class="mb-3">
    <label for="image" class="form-label">Image</label>
    <input type="file" class="form-control" name="image"
           id="image" accept="image/*">
    @if(!empty(Auth::guard('admin')->user()->image))
        <div id="profileImageBlock">
            <a href="{{ url('admin/images/photos/'.Auth::guard('admin')->user()->image) }}"
               target="_blank">View</a>
            <input type="hidden" name="current_image"
                   value="{{ Auth::guard('admin')->user()->image }}">
            <a href="javascript:void(0);" id="deleteProfileImage"
               data-admin-id="{{ Auth::guard('admin')->user()->id }}" class="text-danger">
                Delete</a>
        </div>
    @endif
</div>
```
## Шаг 3. Обновите функцию updateDetails в AdminService:
Мы займемся загрузкой изображений с помощью пакета Intervention и обновим данные администратора.
Создайте уникальное имя изображения и сохраните его в папке с фотографиями:
```php
public function updateDetails($request)
    {
        $data = $request->all();

        // Update Admin Image
        if ($request->hasFile('image')) {
            $image_tmp = $request->file('image');
            if ($image_tmp->isValid()) {
                $manager = new ImageManager(new Driver());
                $image = $manager->read($image_tmp);
                $extension = $image_tmp->getClientOriginalExtension();
                $imageName = rand(111, 99999) . '.' . $extension;
                $image_path = 'admin/images/photos/' . $imageName;
                $image->save($image_path);
            } elseif (!empty($data['current_image'])) {
                $imageName = $data['current_image'];
            } else {
                $imageName = "";
            }
        }

        // Update Admin Details
        Admin::where('email',Auth::guard('admin')->user()->email)->update([
            'name' => $data['name'],
            'mobile' => $data['mobile'],
            'image' => $imageName,
        ]);
    }
```
## Шаг 4. Включите Intervention:
Добавьте необходимые операторы пакета Intervention в верхнюю часть AdminService:
```php
use Intervention\Image\Drivers\Gd\Driver;
use Intervention\Image\ImageManager;
```
## Шаг 5. Обновите файл DetailRequest.php:
Мы добавим правила проверки в файл ```DetailRequest```, чтобы гарантировать загрузку только допустимых изображений:
```php
public function rules(): array
{
    return [
        'name' => 'required|regex:/^[\pL\s\-]+$/u|max:255',
        'mobile' => 'required|numeric|digits:11',
        'image' => 'image',
    ];
}

public function messages(): array
{
    return [
        'name.required' => 'Name is required',
        'name.regex' => 'Valid name is required',
        'name.max' => 'Maximum length is 255 characters',
        'mobile.required' => 'Mobile is required',
        'mobile.numeric' => 'Valid mobile is numeric',
        'mobile.digits' => 'Valid mobile is digits',
        'image.image' => 'Valid image is required',
    ];
}
```
## Шаг 6. Обновите файл header.blade.php:
Мы обновим заголовок страницы администратора, чтобы отображать изображение вошедшего в систему администратора. Если изображение отсутствует, будет показано изображение по умолчанию.
```html
<a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
    <img @if(!empty(Auth::guard('admin')->user()->image))
             src="{{ asset('admin/images/photos/' . Auth::guard('admin')->user()->image) }}"
         @else src="{{ asset('admin/images/user2-160x160.jpg') }}" @endif
        class="user-image rounded-circle shadow" alt="User Image">
    <span class="d-none d-md-inline">{{ Auth::guard('admin')->user()->name }}</span>
</a>
```
## Шаг 7. Удалить изображение профиля с помощью AJAX:
Добавьте следующую функцию ```jQuery``` в файл ```custom.js``` для удаления изображения профиля администратора через ```AJAX```:
```js
$(document).on("click", "#deleteProfileImage", function(){
    if (confirm('Are you sure you want to remove your Profile Image?')) {
        let admin_id = $(this).data('admin-id');
        $.ajax({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            },
            type: "POST",
            url: "delete-profile-image",
            data: { admin_id: admin_id},
            success: function (response) {
                if (response['status'] === true) {
                    alert(response['message']);
                    $('#profileImageBlock').remove();
                }
            },
            error: function () {
                alert("Error occurred while deleting the image.");
            }
        });
    }
});
```
**Создать маршрут для удаления изображения профиля:**

Добавьте следующий маршрут в ```web.php```:
```php
// Delete Profile Image
Route::post('delete-profile-image', [AdminController::class, 'deleteProfileImage']);
```
**Добавьте функцию deleteProfileImage в AdminService:**

Мы удалим изображение из папки и базы данных:
```php
public function deleteProfileImage($adminId): array
{
    $profileImage = Admin::where('id', $adminId)->value('image');
    if ($profileImage) {
        $profileImagePath = 'admin/images/photos/' . $profileImage;
        if (file_exists(public_path($profileImagePath))) {
            unlink(public_path($profileImagePath));
        }
        Admin::where('id', $adminId)->update(['image' => null]);
        return ['status' => true, 'message' => "Profile Image deleted successfully!"];
    } else {
        return ['status' => false, 'message' => "Profile Image not found!"];
    }
}
```
**Добавьте функцию deleteProfileImage в AdminController:**
```php
public function deleteProfileImage(Request $request)
{
    $status = $this->adminService->deleteProfileImage($request->admin_id);
    return response()->json($status);
}
```
# Что дальше?
В [следующей части](15.md) мы продолжим улучшать раздел сведений об администраторе.

[Оглавление](../README.md)
