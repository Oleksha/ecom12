# Часть 32. Модуль продуктов (V) | Добавить/изменить продукт | Добавьте основные поля продукта
В этой части мы продолжаем работу над модулем «Товары» и реализуем полную функциональность добавления/редактирования товаров.
## Шаг 1. Обновить таблицу продуктов.
Сначала обновим таблицу ```products```, поскольку нам нужно добавить значения, допускающие значение ```NULL```, и значения по умолчанию для некоторых столбцов. Также нам нужно обновить столбец ```admin_type``` на ```admin_role```, так как это выглядит более осмысленно.

Обновите файл миграции ```create_products_table.php```, как показано ниже:
```php
public function up(): void
{
    Schema::create('products', function (Blueprint $table) {
        $table->id();
        $table->integer('category_id');
        $table->integer('brand_id')->nullable();
        $table->integer('admin_id');
        $table->string('admin_role');

        $table->string('product_name');
        $table->string('product_code');
        $table->string('product_color');
        $table->string('family_color');
        $table->string('group_code')->nullable();
        $table->float('product_price');
        $table->float('product_discount');
        $table->float('product_discount_amount');

        $table->string('product_applied_on');
        $table->float('product_gst')->default(0);

        $table->float('final_price');
        $table->string('main_image')->nullable();

        $table->float('product_weight')->default(0);
        $table->string('product_video')->nullable();
        $table->text('description')->nullable();
        $table->text('wash_care')->nullable();
        $table->text('search_keywords')->nullable();
        $table->string('fabric')->nullable();
        $table->string('pattern')->nullable();
        $table->string('sleeve')->nullable();
        $table->string('fit')->nullable();
        $table->string('occasion')->nullable();
        $table->integer('stock')->default(0);
        $table->integer('sort')->default(0);

        $table->string('meta_title')->nullable();
        $table->string('meta_description')->nullable();
        $table->string('meta_keywords')->nullable();
        $table->enum('is_featured', ['No', 'Yes']);
        $table->tinyInteger('status');
        $table->timestamps();
    });
}
```
## Шаг 2. Обновить данные таблицы администраторов
Также убедитесь, что в ```AdminsTableSeeder``` должно быть так, как показано ниже, чтобы добавить администраторов/субадминистраторов.
```php
public function run(): void
{
    $password = Hash::make('123456');
    $admin = new Admin;
    $admin->name = 'Oleg Deryabin';
    $admin->role = 'admin';
    $admin->mobile = '79061291066';
    $admin->email = 'admin@mail.ru';
    $admin->password = $password;
    $admin->status = 1;
    $admin->save();

    $admin = new Admin;
    $admin->name = 'Amit Gupta';
    $admin->role = 'subadmin';
    $admin->mobile = '97000000000';
    $admin->email = 'oleksha@mail.ru';
    $admin->password = $password;
    $admin->status = 1;
    $admin->save();

    $admin = new Admin;
    $admin->name = 'John Doe';
    $admin->role = 'subadmin';
    $admin->mobile = '96000000000';
    $admin->email = 'john@mail.ru';
    $admin->password = $password;
    $admin->status = 1;
    $admin->save();
}
```
## Шаг 3. Обновить данные таблицы категорий
Также обязательно добавьте фиктивные категории/подкатегории через CategoryTableSeeder, как показано ниже:
```php
public function run(): void
{
    $categories = [
        ['parent_id' => null, 'name' => 'Одежда', 'url' => 'clothing'],
        ['parent_id' => null, 'name' => 'Электроника', 'url' => 'electronics'],
        ['parent_id' => null, 'name' => 'Бытовая техника', 'url' => 'appliances'],
        ['parent_id' => 1, 'name' => 'Мужская', 'url' => 'men'],
        ['parent_id' => 1, 'name' => 'Женская', 'url' => 'women'],
        ['parent_id' => 1, 'name' => 'Детская', 'url' => 'kids'],
        ['parent_id' => 4, 'name' => 'Мужские футболки', 'url' => 'men-t-shirts'],
    ];
    foreach ($categories as $data) {
        Category::create([
            'parent_id' => $data['parent_id'],
            'name' => $data['name'],
            'url' => $data['url'],
            'image' => '',
            'size_chart' => '',
            'discount' => 0,
            'description' => '',
            'meta_title' => '',
            'meta_description' => '',
            'meta_keywords' => '',
            'status' => 1,
            'menu_status' => 1,
            'created_at' => Carbon::now(),
            'updated_at' => Carbon::now(),
        ]);
    }
}
```
## Шаг 4. Запустить Artisan Command
И после обновления этих файлов выполните следующую команду:
```
php artisan migrate:fresh --seed
```
Она заново создаст все таблицы и записи.

Теперь мы начнем работу по добавлению/редактированию основных полей продукта.
## Шаг 5. Обновите products.blade.php (страница со списком товаров)
- Добавьте кнопку «Добавить продукт» в правый верхний раздел с правами редактирования и полным разрешением:
```html
@if($productsModule['edit_access'] == 1 || $productsModule['full_access'] == 1)
    <a style="max-width: 250px; float:right; display: inline-block;"
       href="{{ route('products.create') }}"
       class="btn btn-block btn-primary">
        Добавить продукт
    </a>
@endif
```
- Добавьте значок «Редактировать» в столбце «Действие» для каждого продукта с правами редактирования и полным разрешением:
```html
@if($productsModule['edit_access'] == 1 || $productsModule['full_access'] == 1)
    <a class="ms-1" href="{{ route('products.edit', $product->id) }}"><i class="fas fa-edit"></i></a>
@endif
```
## Шаг 6. Настройка маршрута ресурсов
Мы используем ресурсные маршруты Laravel по умолчанию в файле ```routes/web.php``` (внутри группы промежуточного ПО администратора):
```php
Route::resource('products', ProductController::class);
```
## Шаг 7. Обновите методы ProductController
- **Показать форму добавления продукта** и получить уровень категорий для возврата в форме добавления продукта
```php
public function create()
{
    $title = "Add Product";
    $getCategories = Category::getCategories('Admin');
    return view('admin.products.add_edit_product', compact('title', 'getCategories'));
}
```
- **Обработка добавления продукта**
```php
public function store(Request $request)
{
    $messages = $this->productService->addEditProduct($request);
    return redirect()->route('products.index')->with('success_message', $messages);
}
```
- **Показать форму редактирования продукта** и получить уровень категорий
```php
public function edit(string $id)
{
    $title = "Edit Product";
    $product = Product::findOrFail($id);
    $getCategories = Category::getCategories('Admin');
    return view('admin.products.add_edit_product', compact('title', 'product', 'getCategories'));
}
```
- **Обработать обновление продукта**
```php
public function update(Request $request, string $id)
{
    $request->merge(['id' => $id]);
    $message = $this->productService->addEditProduct($request);
    return redirect()->route('products.index')->with('success_message', $message);
}
```
Эти методы следуют соглашениям RESTful-контроллера Laravel, обеспечивая чистый и поддерживаемый код.
## Шаг 8. Создайте add_edit_product.blade.php (Форма представления)
На данный момент мы создаем один Blade-файл для операций добавления и редактирования с указанными ниже основными полями.
```html
<form name="productForm" id="productForm" method="post"
      action="{{ isset($product->id) ? route('products.update', $product->id) : route('products.store') }}">@csrf
    @if(isset($product->id)) @method('PATCH') @endif
    <!--begin::Body-->
    <div class="card-body">
        <div class="mb-3">
            <label for="category_id">Category Level (Select Category)*</label>
            <select name="category_id" class="form-control" id="category_id">
                <option value="">Select</option>
                @foreach($getCategories as $cat)
                    <option value="{{ $cat['id'] }}" @if(old('category_id', $product->category_id ?? '') == $cat['id']) selected @endif>{{ $cat['name'] }}</option>
                    @if(!empty($cat['subcategories']))
                        @foreach($cat['subcategories'] as $subcat)
                            <option value="{{ $subcat['id'] }}" @if(old('category_id', $product->category_id ?? '') == $subcat['id']) selected @endif>
                                &nbsp;&nbsp;&nbsp;&nbsp;&raquo;&raquo;{{ $subcat['name'] }}
                            </option>
                            @if(!empty($subcat['subcategories']))
                                @foreach($subcat['subcategories'] as $subsubcat)
                                    <option value="{{ $subsubcat['id'] }}" @if(old('category_id', $product->category_id ?? '') == $subsubcat['id']) selected @endif>
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&raquo;&raquo;{{ $subsubcat['name'] }}
                                    </option>
                                @endforeach
                            @endif
                        @endforeach
                    @endif
                @endforeach
            </select>
        </div>
        <div class="mb-3">
            <label for="product_name" class="form-label">Имя продукта*</label>
            <input type="text" class="form-control" id="product_name"
                   name="product_name" placeholder="Введите имя категории"
                   value="{{ old('product_name', $product->product_name ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="product_code" class="form-label">Код продукта*</label>
            <input type="text" class="form-control" id="product_code"
                   name="product_code" placeholder="Введите код продукта"
                   value="{{ old('product_code', $product->product_code ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="product_color" class="form-label">Цвет продукта*</label>
            <input type="text" class="form-control" id="product_color"
                   name="product_color" placeholder="Введите цвет продукта"
                   value="{{ old('product_color', $product->product_color ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="family_color" class="form-label">Семейство цветов*</label>
            <input type="text" class="form-control" id="family_color"
                   name="family_color" placeholder="Enter Family Color"
                   value="{{ old('family_color', $product->family_color ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="group_code" class="form-label">Group Code</label>
            <input type="text" class="form-control" id="group_code"
                   name="group_code" placeholder="Enter Group Code"
                   value="{{ old('group_code', $product->group_code ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="product_price" class="form-label">Product Price*</label>
            <input type="text" class="form-control" id="product_price"
                   name="product_price" placeholder="Enter Product Price"
                   value="{{ old('product_price', $product->product_price ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="product_discount" class="form-label">Product Discount (%)</label>
            <input type="number" step="0.01" class="form-control"
                   id="product_discount" name="product_discount"
                   value="{{ old('product_discount', $product->product_discount ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="product_gst" class="form-label">Product GST (%)</label>
            <input type="number" step="0.01" class="form-control"
                   id="product_gst" name="product_gst"
                   value="{{ old('product_gst', $product->product_gst ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="product_weight" class="form-label">Вес продукта (г)</label>
            <input type="number" step="0.01" class="form-control"
                   id="product_weight" name="product_weight"
                   value="{{ old('product_weight', $product->product_weight ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="wash_care" class="form-label">Wash Care</label>
            <textarea name="wash_care" class="form-control" placeholder="Enter Wash Care">{{ old('wash_care', $product->wash_care ?? '') }}</textarea>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Описание продукта</label>
            <textarea name="description" class="form-control" placeholder="Введите описание продукта">{{ old('description', $product->description ?? '') }}</textarea>
        </div>
        <div class="mb-3">
            <label for="search_keywords" class="form-label">Search Keywords</label>
            <textarea name="search_keywords" class="form-control" placeholder="Enter Search Keywords">{{ old('search_keywords', $product->search_keywords ?? '') }}</textarea>
        </div>
        <div class="mb-3">
            <label for="meta_title" class="form-label">Meta Title</label>
            <input type="text" class="form-control" id="meta_title"
                   name="meta_title" placeholder="Enter Meta Title"
                   value="{{ old('meta_title', $product->meta_title ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="meta_description" class="form-label">Meta Description</label>
            <input type="text" class="form-control" id="meta_description"
                   name="meta_description" placeholder="Enter Meta Description"
                   value="{{ old('meta_description', $product->meta_description ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="meta_keywords" class="form-label">Meta Keywords</label>
            <input type="text" class="form-control" id="meta_keywords"
                   name="meta_keywords" placeholder="Enter Meta Keywords"
                   value="{{ old('meta_keywords', $product->meta_keywords ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="is_featured" class="form-label">Is Featured?</label>
            <select name="is_featured" id="is_featured" class="form-select">
                <option value="No" {{ (old('is_featured' , $product->is_featured ?? '') == 'No') ? 'selected' : '' }}></option>
                <option value="Yes" {{ (old('is_featured' , $product->is_featured ?? '') == 'Yes') ? 'selected' : '' }}></option>
            </select>
        </div>
    </div>
    <!--end::Body-->
    <!--begin::Footer-->
    <div class="card-footer">
        <button type="submit" class="btn btn-primary">Submit</button>
    </div>
    <!--end::Footer-->
</form>
```
## Шаг 9. Создайте addEditProduct() в ProductService.
```php
public function addEditProduct(Request $request): string
{
    $data = $request->all();

    if (isset($data['id']) && $data['id'] != '') {
        $product = Product::find($data['id']);
        $message = 'Product updated successfully!';
    } else {
        $product = new Product();
        $message = 'Product added successfully!';
    }

    $product->admin_id = Auth::guard('admin')->user()->id;
    $product->admin_role = Auth::guard('admin')->user()->role;

    $product->category_id = $data['category_id'];
    $product->product_name = $data['product_name'];
    $product->product_code = $data['product_code'];
    $product->product_color = $data['product_color'];
    $product->family_color = $data['family_color'];
    $product->group_code = $data['group_code'];
    $product->product_weight = $data['product_weight'] ?? 0;
    $product->product_price = $data['product_price'];
    $product->product_gst = $data['product_gst'] ?? 0;
    $product->product_discount = $data['product_discount'] ?? 0;
    $product->is_featured = $data['is_featured'] ?? 'No';

    // Calculate discount & final price
    if (!empty($data['product_discount']) && $data['product_discount'] > 0) {
        $product->product_applied_on = 'product';
        $product->product_discount_amount = ($data['product_price'] * $data['product_discount']) / 100;
    } else {
        $getCategoryDiscount = Category::select('discount')
            ->where('id', $data['category_id'])->first();
        if ($getCategoryDiscount && $getCategoryDiscount->discount > 0) {
            $product->product_applied_on = 'category';
            $product->product_discount = $getCategoryDiscount->discount;
            $product->product_discount_amount = ($data['product_price'] * $getCategoryDiscount->discount) / 100;
        } else {
            $product->product_applied_on = '';
            $product->product_discount_amount = 0;
        }
    }

    $product->final_price = $data['product_price'] - $product->product_discount_amount;

    // Optional fields
    $product->description = $data['product_description'] ?? '';
    $product->wash_care = $data['wash_care'] ?? '';
    $product->search_keywords = $data['search_keywords'] ?? '';
    $product->meta_title = $data['meta_title'] ?? '';
    $product->meta_description = $data['meta_description'] ?? '';
    $product->meta_keywords = $data['meta_keywords'] ?? '';
    $product->status = 1;

    $product->save();
    
    return $message;
}
```
## Шаг 10. Необходимый импорт заголовков
В верхней части файла ```ProductService.php``` добавьте:
```php
use App\Models\AdminsRole;
use App\Models\Category;
use App\Models\Product;
use Illuminate\Support\Facades\Auth;
```
Обязательно добавьте следующие классы в верхнюю часть ProductController:
```php
use App\Models\Category;
use App\Models\Product;
use App\Services\Admin\ProductService;
use Illuminate\Support\Facades\Session;
```
## Шаг 11. Показать сообщение об успешном завершении в index.blade.php 
Отобразить флэш-сообщение после успешного добавления/обновления продукта:
```html
@if(Session::has('success_message'))
    <div class="alert alert-success alert-dismissible fade show m-3" role="alert">
        <strong>Success: </strong> {{ Session::get('success_message') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
@endif
```
К концу этой части вы сможете динамически добавлять и редактировать продукты из панели администратора.
# Что дальше?
В [следующей части](33.md) мы реализуем загрузку изображений и видео методом перетаскивания с помощью ```Dropzone.js``` для продуктов в панели администратора.

[Оглавление](../README.md)
