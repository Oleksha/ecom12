# Часть 4. Создание admin Middleware и защита маршрутов admin

В этой части мы реализуем множественную аутентификацию с использованием Guards для администраторов, субадминистраторов и поставщиков, сохранив при этом аутентификацию Laravel по умолчанию для пользователей.

Мы также создадим административное промежуточное ПО для защиты маршрутов административной панели от несанкционированного доступа.

Что вы узнаете из этого видео:
- Создайте таблицу ```admins``` для хранения данных администратора, субадминистратора и поставщика.
- Обновите модель администрирования для поддержки аутентификации.
- Настройте ```auth.php``` для определения защитных механизмов аутентификации для администраторов и поставщиков.
- Создайте административное промежуточное ПО для ограничения доступа к панели администратора
- Защита административных маршрутов с помощью промежуточного программного обеспечения

## Шаг 1. Создать таблицу администраторов

Сначала мы создадим новую таблицу администраторов для хранения данных администраторов, субадминистраторов и поставщиков.

Эта таблица будет содержать следующие столбцы: id, name, role, mobile, email, password, image, status, timestamps

Выполните следующую команду Artisan для создания файла миграции:
```
php artisan make:migration create_admins_table
```
Откройте сгенерированный файл миграции и добавьте необходимые столбцы:
```php
Schema::create('admins', function (Blueprint $table) {
    $table->id();
    $table->string('name');
    $table->string('role');
    $table->string('mobile');
    $table->string('email')->unique();
    $table->string('password');
    $table->string('image')->nullable();
    $table->tinyInteger('status');
    $table->timestamps();
});
```
Теперь выполните команду миграции, чтобы создать таблицу в базе данных:
```
php artisan миграция
```
## Шаг 2. Обновление модели администратора для аутентификации

Расширьте модель ```Admin``` с ```Authenticable``` вместо ```Model``` для поддержки аутентификации.

Определите администратора-защитника, чтобы гарантировать, что Laravel использует правильную систему аутентификации.
```php
namespace App\Models;

use Illuminate\Foundation\Auth\User as Authenticatable;

class Admin extends Authenticatable
{
    protected $guard = 'admin';
}
```
## Шаг 3. Обновление ```auth.php``` для администраторов и поставщиков.

Определите охранников:
```php
'guards' => [
    'web' => [
        'driver' => 'session',
        'provider' => 'users',
    ],
    'admin' => [
        'driver' => 'session',
        'provider' => 'admins',
    ],
],
```
Определите поставщиков:
```php
'providers' => [
    'users' => [
        'driver' => 'eloquent',
        'model' => env('AUTH_MODEL', App\Models\User::class),
    ],
    'admins' => [
        'driver' => 'eloquent',
        'model' => App\Models\Admin::class,
    ],
],
```
Теперь Laravel будет аутентифицировать администраторов отдельно от обычных пользователей.

## Шаг 4. Создание и настройка административного промежуточного программного обеспечения

Создать промежуточное программное обеспечение:
```
php artisan make:middleware Admin
```
Обновите логику промежуточного программного обеспечения:
```php
public function handle(Request $request, Closure $next): Response
{
    if (!Auth::guard('admin')->check()) {
        return redirect()->route('admin.login');
    }
    return $next($request);
}
```
Это гарантирует, что доступ к административным маршрутам смогут получить только аутентифицированные администраторы.

## Шаг 5. Регистрация промежуточного программного обеспечения в ```app.php```

Вместо ```Kernel.php``` теперь мы регистрируем промежуточное ПО в ```bootstrap/app.php```:
```php
->withMiddleware(function (Middleware $middleware): void {
    $middleware->alias(['admin' => \App\Http\Middleware\Admin::class]);
})
```
Это позволяет Laravel распознавать административное промежуточное ПО глобально.

## Шаг 6. Защитите административные маршруты в ```web.php```

Добавьте административное промежуточное ПО для защиты административных маршрутов:
```php
Route::prefix('admin')->group(function () {
    // Show login form
    Route::get('login', [AdminController::class, 'create'])->name('admin.login');
    
    Route::group(['middleware' => ['admin']], function () {
        // Dashboard route
        Route::resource('dashboard', AdminController::class)->only(['index']);
    });
});
```
Теперь доступ к панели управления смогут получить только аутентифицированные администраторы!

Итоговый обзор:
- Создана таблица администраторов для аутентификации администраторов, субадминистраторов и поставщиков.
- Обновленная модель администрирования для поддержки аутентификации
- Настроенный ```auth.php``` для нескольких аутентификационных защитников
- Создано административное промежуточное ПО для безопасного доступа
- Зарегистрированное промежуточное ПО в ```app.php```
- Защищенные административные маршруты с использованием промежуточного программного обеспечения

Документация по множественной аутентификации Laravel: https://laravel.com/docs/12.x/authentication

# Что дальше?

В [следующей части](05.md) мы создадим запись входа администратора и впервые войдем в панель администратора!

[Оглавление](../README.md)
