# Часть 4. Создание посредника для защита admin-маршрутов
В этой части мы реализуем аутентификацию с использованием Guards для администраторов, субадминистраторов и поставщиков, сохранив при этом аутентификацию Laravel по умолчанию для пользователей.

Мы также создадим посредника для защиты admin-маршрутов от несанкционированного доступа.
## Шаг 1. Создадим таблицу admins
Сначала мы создадим новую таблицу admins для хранения данных администраторов, субадминистраторов и поставщиков.

Эта таблица будет содержать следующие столбцы: **id**, **name**, **role**, **mobile**, **email**, **password**, **image**, **status**, **timestamps**.

Выполните следующую команду **Artisan** для создания файла миграции:
```
php artisan make:migration create_admins_table
```
Откройте сгенерированный файл миграции и добавьте необходимые столбцы:
```php
Schema::create('admins', function (Blueprint $table) {
    $table->id();
    $table->string('name');
    $table->string('role');
    $table->string('mobile');
    $table->string('email')->unique();
    $table->string('password');
    $table->string('image')->nullable();
    $table->tinyInteger('status');
    $table->timestamps();
});
```
Теперь выполните команду artisan, чтобы создать таблицу в базе данных:
```
php artisan migrate
```
## Шаг 2. Обновите модель **Admin**.
Измените расширение модели **Admin** на **Authenticable** вместо **Model** для поддержки аутентификации.

Определите защитника - guard, чтобы Laravel использовал систему аутентификации.
```php
namespace App\Models;

use Illuminate\Foundation\Auth\User as Authenticatable;

class Admin extends Authenticatable
{
    protected $guard = 'admin';
}
```
## Шаг 3. Обновите **config/auth.php** для использования этого класса.

Добавьте созданного защитника **admin** в массив **guards**:
```php
'guards' => [
    'web' => [
        'driver' => 'session',
        'provider' => 'users',
    ],
    'admin' => [
        'driver' => 'session',
        'provider' => 'admins',
    ],
],
```
Определите какая Model будет обрабатывать созданного защитника в массиве **providers**:
```php
'providers' => [
    'users' => [
        'driver' => 'eloquent',
        'model' => env('AUTH_MODEL', App\Models\User::class),
    ],
    'admins' => [
        'driver' => 'eloquent',
        'model' => App\Models\Admin::class,
    ],
],
```
Теперь Laravel будет аутентифицировать администраторов отдельно от обычных пользователей.
## Шаг 4. Создание и настройка посредника **Admin**
Создаим посредника:
```
php artisan make:middleware Admin
```
Обновите логику созданного класса **app/Http/Middleware/Admin.php**:
```php
public function handle(Request $request, Closure $next): Response
{
    if (!Auth::guard('admin')->check()) {
        return redirect()->route('admin.login');
    }
    return $next($request);
}
```
Это изменение гарантирует, что доступ к административным маршрутам смогут получить только аутентифицированные администраторы.
## Шаг 5. Регистрация посредника в **app.php**
В этой версии Laravel вместо **Kernel.php** мы регистрируем посредника в **bootstrap/app.php**:
```php
->withMiddleware(function (Middleware $middleware): void {
    $middleware->alias(['admin' => \App\Http\Middleware\Admin::class]);
})
```
Это позволит Laravel распознавать посредников глобально.
## Шаг 6. Защитите admin-маршруты в **web.php**.
Добавьте созданного посредника для защиты административных маршрутов:
```php
Route::prefix('admin')->group(function () {
    // Показать страницу входа
    Route::get('login', [AdminController::class, 'create'])->name('admin.login');
    
    Route::group(['middleware' => ['admin']], function () {
        // Панель управления
        Route::resource('dashboard', AdminController::class)->only(['index']);
    });
});
```
Теперь доступ к панели управления смогут получить только аутентифицированные администраторы!

Документация по аутентификации Laravel: [https://laravel.com/docs/12.x/authentication](https://laravel.su/docs/12.x/authentication)
# Что дальше?

В [следующей части](05.md) мы создадим администратора и впервые войдем в панель администратора!

[Оглавление](../README.md)
