# Часть 33. Модуль «Продукты» (VI) | Загрузка и удаление изображений и видео товаров с помощью функции перетаскивания файлов Dropzone в Laravel
В этой части мы реализовали загрузку изображений и видео методом перетаскивания с помощью ```Dropzone.js``` для товаров в панели администратора. Это включает в себя:
- Загрузка основного изображения продукта с возможностью предварительного просмотра и удаления
- Загрузка видео о продукте с возможностью просмотра и удаления
- Внутренняя обработка загрузки файлов
- Удаление файлов из файловой системы и базы данных
- Интеграция с Dropzone.js и jQuery
## Шаг 1. Blade View (добавление полей в add_edit_product.blade.php)
**Поле загрузки основного изображения продукта**
```html
<div class="mb-3">
    <label for="main_image_dropzone" class="form-label">Product Main Image (Max 500 KB)</label>
    <div class="dropzone" id="mainImageDropzone"></div>

    @if(!empty($product['main_image']))
    <a target="_blank" href="{{ url('front/images/products/' . $product['main_image']) }}">
        <img style="width: 50px; margin: 10px" src="{{ asset('/front/images/products/' . $product['main_image']) }}" alt="{{ $product['product_name'] }}">
    </a>
    <a style="color: #3f6ed3" class="confirmDelete"
       title="DeleteProduct Image" href="javascript:void(0)"
       data-module="product-main-image" data-id="{{ $product['id'] }}"><i class="fas fa-trash"></i></a>
    @endif

    <!-- Hidden input to send uploaded image -->
    <input type="hidden" name="main_image" id="main_image_hidden">
</div>
```
**Поле загрузки видео о продукте**
```html
<div class="mb-3">
    <label for="main_image_dropzone" class="form-label">Product Video (Max 2 MB)</label>
    <div class="dropzone" id="productVideoDropzone"></div>

    @if(!empty($product['product_video']))
        <a target="_blank" href="{{ url('front/videos/products/' . $product['product_video']) }}">
            View Video
        </a> | <a class="confirmDelete" href="javascript:void(0)"
           data-module="product-video" data-id="{{ $product['id'] }}">Delete Video</a>
    @endif

    <!-- Hidden input to send uploaded image -->
    <input type="hidden" name="product_video" id="product_video_hidden">
</div>
```
## Шаг 2. Добавьте Dropzone CSS (styles.blade.php) и JS (scripts.blade.php)
```js
<!-- Dropzone CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css" rel="stylesheet">

<!-- Dropzone JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>
<script>
    Dropzone.autoDiscover = false;

    // Main Image Dropzone
    let mainImageDropzone = new Dropzone('#mainImageDropzone', {
        url: "{{ route('product.upload.image') }}",
        maxFiles: 1,
        acceptedFiles: "image/*",
        maxFilesize: 0.5,
        addRemoveLinks: true,
        dictDefaultMessage: 'Drag & drop product image or click to upload',
        headers: {
            'X-CSRF-TOKEN': "{{ csrf_token() }}"
        },
        success: function (file, response) {
            document.getElementById('main_image_hidden').value = response.fileName;
        },
        error: function (file, message) {
            alert(message);
            this.removeFile(file);
        },
        init: function () {
            this.on('maxfilesexceeded', function (file) {
                this.rmoveAllFiles();
                this.addFile(file);
            });
        }
    });

    // Product Video Dropzone
    let productVideoDropzone = new Dropzone('#productVideoDropzone', {
        url: "{{ route('product.upload.video') }}",
        maxFiles: 1,
        acceptedFiles: "video/*",
        maxFilesize: 2,
        addRemoveLinks: true,
        dictDefaultMessage: 'Drag & drop product video or click to upload',
        headers: {
            'X-CSRF-TOKEN': "{{ csrf_token() }}"
        },
        success: function (file, response) {
            document.getElementById('product_video_hidden').value = response.fileName;
        },
        error: function (file, message) {
            alert(message);
            this.removeFile(file);
        },
        init: function () {
            this.on('maxfilesexceeded', function (file) {
                this.rmoveAllFiles();
                this.addFile(file);
            });
        }
    });
</script>
```
## Шаг 3. Маршруты в web.php
```php
Route::post('product/upload-image', [ProductController::class, 'uploadImage'])->name('product.upload.image');
Route::post('product/upload-video', [ProductController::class, 'uploadVideo'])->name('product.upload.video');
Route::get('delete-product-mail-image/{id?}', [ProductController::class, 'deleteProductMainImage']);
Route::get('delete-product-video/{id?}', [ProductController::class, 'deleteProductVideo']);
```
## Шаг 4. Методы контроллера в ProductController.php
```php
public function uploadImage(Request $request)
{
    if ($request->hasFile('file')) {
        $fileName = $this->productService->handleImageUpload($request->file('file'));
        return response()->json(['fileName' => $fileName]);
    }
    return response()->json(['error' => 'No file was uploaded.'], 400);
}

public function uploadVideo(Request $request)
{
    if ($request->hasFile('file')) {
        $fileName = $this->productService->handleVideoUpload($request->file('file'));
        return response()->json(['fileName' => $fileName]);
    }
    return response()->json(['error' => 'No file was uploaded.'], 400);
}

public function deleteProductMainImage(string $id)
{
    $message = $this->productService->deleteProductMainImage($id);
    return redirect()->back()->with('success_message', $message);
}

public function deleteProductVideo(string $id)
{
    $message = $this->productService->deleteProductVideo($id);
    return redirect()->back()->with('success_message', $message);
}
```
## Шаг 5. Методы сервиса в ProductService.php
```php
public function handleImageUpload($file): string
{
    $imageName = time() . '.' . $file->getClientOriginalName();
    $file->move(public_path('front/images/products'), $imageName);
    return $imageName;
}

public function handleVideoUpload($file)
{
    $videoName = time() . '.' . $file->getClientOriginalName();
    $file->move(public_path('front/videos/products'), $videoName);
    return $videoName;
}

public function deleteProductMainImage(string $id)
{
    // Get product Main Image
    $product = Product::select('main_image')->where('id', $id)->first();

    if (!$product || !$product->main_image) {
        return 'No image found';
    }

    // Get Product Image Path
    $image_path = public_path('front/images/products/' . $product->main_image);

    // Delete Product Main Image if exists
    if (file_exists($image_path)) {
        unlink($image_path);
    }
    
    // Delete Product Main Image from products table
    Product::where('id', $id)->update(['main_image' => null]);
    
    return 'Product main image has been deleted successfully!';
}

public function deleteProductVideo(string $id)
{
    // Get Product Video
    $product = Product::select('product_video')->where('id', $id)->first();

    if (!$product || !$product->product_video) {
        return 'No video found';
    }

    // Get Product Video Path
    $product_video_path = public_path('front/videos/products/' . $product->product_video);

    // Delete Product Main Image if exists
    if (file_exists($product_video_path)) {
        unlink($product_video_path);
    }

    // Delete Product Main Image from products table
    Product::where('id', $id)->update(['product_video' => null]);

    return 'Product Video has been deleted successfully!';
}
```
## Шаг 6. Обновите addEditProduct() в ProductService.php
```php
// Upload Main Image
if (!empty($data['main_image_hidden'])) {
    $sourcePath = public_path('temp/' . $data['main_image_hidden']);
    $destinationPath = public_path('front/images/products/' . $data['main_image_hidden']);

    if (file_exists($sourcePath)) {
        @copy($sourcePath, $destinationPath);
        @unlink($sourcePath);
    }

    $product->main_image = $data['main_image_hidden'];
}

// Upload Product Video
if (!empty($data['product_video_hidden'])) {
    $sourcePath = public_path('temp/' . $data['product_video_hidden']);
    $destinationPath = public_path('front/videos/products/' . $data['product_video_hidden']);

    if (file_exists($sourcePath)) {
        @copy($sourcePath, $destinationPath);
        @unlink($sourcePath);
    }

    $product->product_video = $data['product_video_hidden'];
}
        
$product->main_image = $request->main_image ?? $product->main_image;
$product->product_video = $request->product_video ?? $product->product_video;
```
## Шаг 7. Обработчик удаления jQuery в custom.js
```js
$(document).on('click', '.confirmDelete', function (e) {
    e.preventDefault();
    let button = $(this);
    let module = button.data('module');
    let module_id = button.data('id');
    let form = button.closest('form');
    let redirectUrl = '/admin/delete-' + module + '/' + module_id;
    Swal.fire({
        title: 'Вы уверены?',
        text: "Вы не сможете это изменить!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33d33',
        confirmButtonText: 'Да, удалить!',
    }).then((result) => {
        if (result.isConfirmed) {
            // Проверяем, существует ли форма и есть ли маршрут удаления.
            if (form.length > 0 && form.attr('action') && form.attr('method') === 'POST') {
                // Создать и добавляет скрытый input _method, если он отсутствует.
                if (form.find("input['_method']").length === 0) {
                    form.append('<input type="hidden" name="_method" value="DELETE">');
                }
                form.submit(); // Отправить форму (используется в модуле категорий)
            } else {
                // Перенаправление, если отсутствует форма удаления.
                window.location.href = redirectUrl;
            }
        }
    });
});
```
### Окончательный результат
- Администраторы продукта могут перетаскивать файлы изображений и видео.
- Файлы загружаются мгновенно с помощью AJAX через Dropzone.js.
- Ссылки на предпросмотр изображений и просмотр видео
- Кнопки «Удалить» для мгновенного удаления файлов с сервера и базы данных
# Что дальше?
В [следующей части](34.md) мы будем динамически управлять цветами семейства из базы данных, создав ее таблицу.

[Оглавление](../README.md)
