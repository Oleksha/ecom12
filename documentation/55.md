# Часть 55. Управление баннерами на главной странице (III) | Добавление/редактирование баннера с проверкой и загрузкой изображения.
В этой части мы создадим форму «Добавить/редактировать баннер» в панели администратора, а также реализуем функции проверки на стороне сервера и загрузки изображений баннеров. На этом CRUD-операции на стороне администратора для баннеров на главной странице завершаются.

Что мы рассмотрим в этой части:
1. Создайте форму add_edit_banner.blade.php для добавления/редактирования баннеров.
2. Добавьте BannerRequest для проверки на стороне сервера.
3. Обновите BannerService для обработки логики добавления/редактирования, включая загрузку изображений.
4. Обновите BannerController, чтобы использовать новую форму и запрос.
5. Правильно отображайте сообщения об ошибках/успехе в форме.

## Шаг 1. Создайте BannerRequest для проверки
Команда artisan:
```
php artisan make:request Admin/BannerRequest
```
Обновите **app/Http/Requests/Admin/BannerRequest.php**
```php
namespace App\Http\Requests\Admin;

use Illuminate\Foundation\Http\FormRequest;

class BannerRequest extends FormRequest
{
    /**
     * Determine if the user is authorized to make this request.
     */
    public function authorize(): bool
    {
        return true;
    }

    /**
     * Get the validation rules that apply to the request.
     *
     * @return array<string, \Illuminate\Contracts\Validation\ValidationRule|array<mixed>|string>
     */
    public function rules(): array
    {
        $rules = [
            'type' => 'required|string|max:255',
            'link' => 'nullable|url|max:500',
            'title' => 'required|string|max:255',
            'alt' => 'nullable|string|max:255',
            'sort' => 'nullable|integer|min:0',
            'status' => 'nullable|in:0,1',
        ];

        // For create or edit - validate image only if uploading
        if ($this->isMethod('post') || $this->hasFile('image')) {
            $rules['image'] = 'required|image|mimes:jpeg,jpg,png,gif|max:2048'; // Max 2Mb
        }
        
        return $rules;
    }
    
    public function messages(): array
    {
        return [
            'type.required' => 'Please select a banner type.',
            'title.required' => 'Banner title is required.',
            'image.required' => 'Please upload a banner image.',
            'image.image' => 'Uploaded file must be an image.',
            'image.mimes' => 'Allowed image types are jpeg, jpg, png, gif.',
            'image.max' => 'Image size must be less than 2Mb.',
        ];
    }
}
```
## Шаг 2. Обновите BannerController.php для использования BannerRequest.
Мы обновим методы **store()** и **update()** в **BannerController.php** для использования нового **BannerRequest**.
```php
use App\Http\Requests\Admin\BannerRequest;

class BannerController extends Controller
{
    /**
     * Store a newly created resource in storage.
     */
    public function store(BannerRequest $request)
    {
        $message = $this->bannerService->addEditBanner($request);
        return redirect()->route('banners.index')->with('success_message', $message);
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(BannerRequest $request, string $id)
    {
        $request->merge(['id' => $id]);
        $message = $this->bannerService->addEditBanner($request);
        return redirect()->route('banners.index')->with('success_message', $message);
    }
}
```
## Шаг 3. Обновите BannerService.php с помощью функции «Добавить/изменить логику баннера».
Этот метод обрабатывает как добавление, так и редактирование баннера, включая загрузку изображений, статус и логику сортировки.
```php
public function addEditBanner($request): string
{
$data = $request->all();

$banner = isset($data['id']) ? Banner::find($data['id']) : new Banner();
$banner->type = $data['type'];
$banner->link = $data['link'];
$banner->title = $data['title'];
$banner->alt = $data['alt'];
$banner->sort = $data['sort'] ?? 0;
$banner->status = $data['status'] ?? 1;

// Handle image upload
if ($request->hasFile('image')) {
    $path = public_path('front/images/banners/');
    if (!File::exists($path)) {
        File::makeDirectory($path, $mode = 0755, true);
    }

    // Delete old image if editing
    if (!empty($banner->image) && File::exists($path . $banner->image)) {
        File::delete($path . $banner->image);
    }
    
    $image = $request->file('image');
    $imageName = time() . '-' . $image->getClientOriginalName();
    $image->move($path, $imageName);
    $banner->image = $imageName;
}

$banner->save();
return isset($data['id']) ? 'Banner updated successfully!' : 'Banner added successfully!';
}
```
## Шаг 4. Создайте resources/views/admin/banners/add_edit_banner.blade.php
Теперь мы создадим форму **add_edit_banner.blade.php** для добавления/редактирования баннеров.
```html
@extends('admin.layout.layout')
@section('content')
<main class="app-main">
    <!--begin::App Content Header-->
    <div class="app-content-header">
        <!--begin::Container-->
        <div class="container-fluid">
            <!--begin::Row-->
            <div class="row">
                <div class="col-sm-6"><h3 class="mb-0">Управление баннерами</h3></div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-end">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">{{ $title }}</li>
                    </ol>
                </div>
            </div>
            <!--end::Row-->
        </div>
        <!--end::Container-->
    </div>
    <!--end::App Content Header-->
    <!--begin::App Content-->
    <div class="app-content">
        <!--begin::Container-->
        <div class="container-fluid">
            <!--begin::Row-->
            <div class="row g-4">
                <!--begin::Col-->
                <div class="col-md-6">
                    <!--begin::Quick Example-->
                    <div class="card card-primary card-outline mb-4">
                        <!--begin::Header-->
                        <div class="card-header"><div class="card-title">{{ $title }}</div></div>
                        <!--end::Header-->
                        @if(Session::has('error_message'))
                        <div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
                            <strong>Ошибка: </strong> {{ Session::get('error_message') }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        @endif
                        @if(Session::has('success_message'))
                        <div class="alert alert-success alert-dismissible fade show m-3" role="alert">
                            <strong>Успешно: </strong> {{ Session::get('success_message') }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        @endif
                        @foreach($errors->all() as $error)
                        <div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
                            <strong>Ошибка! </strong> {!! $error !!}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        @endforeach
                        <!--begin::Form-->
                        <form name="bannerForm" id="bannerForm" method="post"
                              action="{{ isset($banner->id) ? route('banners.update', $banner->id) : route('banners.store') }}"
                              enctype="multipart/form-data">@csrf
                            @if(isset($banner->id)) @method('PATCH') @endif
                            <!--begin::Body-->
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="type" class="form-label">Тип баннера*</label>
                                    <select name="type" id="type" class="form-select">
                                        <option value="">Выберите Тип</option>
                                        <option value="Slider" {{ old('type', $banner->type ?? '') == 'Slider' ? 'selected' : '' }}>Слайдер</option>
                                        <option value="Fix" {{ old('type', $banner->type ?? '') == 'Fix' ? 'selected' : '' }}>Фиксированный</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="title" class="form-label">Заголовок баннера*</label>
                                    <input type="text" class="form-control" id="title"
                                           name="title" placeholder="Введите заголовок баннера"
                                           value="{{ old('title', $banner->title ?? '') }}">
                                </div>
                                <div class="mb-3">
                                    <label for="alt" class="form-label">Альтернативный текст</label>
                                    <input type="text" class="form-control" id="alt"
                                           name="alt" placeholder="Введите альтернативный текст"
                                           value="{{ old('alt', $banner->alt ?? '') }}">
                                </div>
                                <div class="mb-3">
                                    <label for="link" class="form-label">Ссылка баннера</label>
                                    <input type="text" class="form-control" id="link"
                                           name="link" placeholder="Введите ссылку баннера"
                                           value="{{ old('link', $banner->link ?? '') }}">
                                </div>
                                <div class="mb-3">
                                    <label for="sort" class="form-label">Номер для сортировки</label>
                                    <input type="number" class="form-control" id="sort"
                                           name="sort" value="{{ old('sort', $banner->sort ?? 0) }}">
                                </div>
                                <div class="mb-3">
                                    <label for="image" class="form-label">Изображение баннера@if(!isset($banner->id))*@endif</label>
                                    <input type="file" class="form-control" id="image"
                                           name="image" accept="image/*">
                                    @if(!empty($banner->image))
                                    <div class="mt-2">
                                        <img src="{{ asset('front/images/banners/' . $banner->image) }}" width="100" alt="Изображение баннера">
                                    </div>
                                    @endif
                                </div>
                                <div class="mb-3">
                                    <label for="status" class="form-check-label">Статус активности</label><br>
                                    <input type="checkbox" name="status"
                                           id="status" class="form-check-input"
                                           value="1" {{ (old('status', $banner->status ?? 1) == 1) ? 'checked' : '' }}>
                                </div>
                            </div>
                            <!--end::Body-->
                            <!--begin::Footer-->
                            <div class="card-footer">
                                <button type="submit" class="btn btn-primary">Завершить</button>
                            </div>
                            <!--end::Footer-->
                        </form>
                        <!--end::Form-->
                    </div>
                    <!--end::Quick Example-->
                </div>
                <!--end::Col-->
            </div>
            <!--end::Row-->
        </div>
        <!--end::Container-->
    </div>
    <!--end::App Content-->
</main>
@endsection
```
Обновите методы **create()** и **edit()**:
```php
/**
 * Show the form for creating a new resource.
 */
public function create()
{
    $title = 'Add Brand';
    return view('admin.brands.add_edit_brand', compact('title'));
}

/**
 * Show the form for editing the specified resource.
 */
public function edit(string $id)
{
    $title = 'Edit Brand';
    $brand = Brand::findOrFail($id);
    return view('admin.brands.add_edit_brand', compact('title', 'brand'));
}
```
Изменим **sidebar.blade.php** для управления баннерами
```html
<li class="nav-item {{ in_array(Session::get('page'), ['banners']) ? 'menu-open' : '' }}">
    <a href="#" class="nav-link {{ in_array(Session::get('page'), ['banners']) ? 'active' : '' }}">
        <i class="nav-icon bi bi-clipboard-fill"></i>
        <p>
            Баннеры
            <i class="nav-arrow bi bi-chevron-right"></i>
        </p>
    </a>
    <ul class="nav nav-treeview">
        <li class="nav-item">
            <a href="{{ route('banners.index') }}" class="nav-link {{ (Session::get('page') == 'banners') ? 'active' : '' }}">
                <i class="nav-icon bi bi-circle"></i>
                <p>Баннеры</p>
            </a>
        </li>
    </ul>
</li>
```
# Что дальше?
В [следующей части](56.md) мы динамически отобразим баннеры на главной странице, используя данные из таблицы баннеров.

[Оглавление](../README.md)
