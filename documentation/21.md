# Часть 21. Модуль «Категории» (III) | Функциональность добавления и редактирования категорий
В этой части мы продолжаем работу над модулем категорий и реализуем полную функциональность добавления/редактирования категорий.
## Шаг 1. Обновление ```categories.blade.php``` (страница списка категорий)
Добавьте кнопку «Добавить категорию» в правый верхний раздел:
```html
<a style="max-width: 250px; float:right; display: inline-block;"
   href="{{ route('categories.create') }}"
   class="btn btn-block btn-primary">
    Добавить категорию
</a>
```
Добавьте значок «Изменить» в столбец «Действие» для каждой категории:
```html
<a href="{{ route('categories.edit', $category->id) }}">
    <i class="fas fa-edit"></i>
</a>
```
## Шаг 2. Настройка маршрута ресурса
Мы используем ресурсные маршруты Laravel по умолчанию в файле ```routes/web.php``` (внутри группы промежуточного ПО администратора):
```php
Route::resource('categories', CategoryController::class);
```
## Шаг 3. Обновите методы CategoryController
Показать форму добавления категории
```php
public function create()
{
    $title = 'Добавить категорию';
    return view('admin.categories.add_edit_category', compact('title'));
}
```
Обработка добавления категории
```php
public function store(Request $request)
{
    $message = $this->categoryService->addEditCategory($request);
    return redirect()->route('categories.index')->with('success_message', $message);
}
```
Показать форму редактирования категории
```php
public function edit(string $id)
{
    $title = 'Редактировать категорию';
    $category = Category::findOrFail($id);
    return view('admin.categories.add_edit_category', compact('title', 'category'));
}
```
Обработка отправки редактирования категории
```php
public function update(Request $request, string $id)
{
    $request->merge(['id' => $id]);
    $message = $this->categoryService->addEditCategory($request);
    return redirect()->route('categories.index')->with('success_message', $message);
}
```
Эти методы следуют соглашениям RESTful-контроллера Laravel, обеспечивая чистый и поддерживаемый код.
## Шаг 4. Создайте ```add_edit_category.blade.php``` (Форма представления)

Мы создаем один Blade-файл для операций добавления и редактирования.

Он включает в себя:
- Поля формы для: названия категории, изображения, Size Chart, скидки, URL-адреса, описания, метатегов
- Отображение существующих изображений при редактировании
- Обработка условных маршрутов для хранения и обновления
```html
<form name="categoryForm" id="categoryForm" method="post"
      action="{{ isset($category) ? route('categories.update', $category->id) : route('categories.store') }}"
      enctype="multipart/form-data">@csrf
    <!--begin::Body-->
    <div class="card-body">
        <div class="mb-3">
            <label for="category_name" class="form-label">Имя категории</label>
            <input type="text" class="form-control" id="category_name"
                   name="category_name" placeholder="Введите имя категории"
                   value="{{ old('category_name', $category->name ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="category_image" class="form-label">Изображение</label>
            <input type="file" class="form-control" id="category_image"
                   name="category_image" accept="image/*">
            @if(!empty($category->image))
                <div class="mt-2">
                    <img src="{{ asset('front/images/categories/' . $category->image) }}" width="50" alt="Изображение">
                </div>
            @endif
        </div>
        <div class="mb-3">
            <label for="size_chart" class="form-label">Size Chart</label>
            <input type="file" class="form-control" id="size_chart"
                   name="size_chart" accept="image/*">
            @if(!empty($category->size_chart))
                <div class="mt-2">
                    <img src="{{ asset('front/images/size-chart/' . $category->size_chart) }}" width="50" alt="Size Chart">
                </div>
            @endif
        </div>
        <div class="mb-3">
            <label for="category_discount" class="form-label">Скидка</label>
            <input type="text" class="form-control" placeholder="Введите скидку"
                   id="category_discount" name="category_discount"
                   value="{{ old('category_discount', $category->discount ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="url" class="form-label">URL</label>
            <input type="text" class="form-control" placeholder="Введите скидку"
                   id="url" name="url"
                   value="{{ old('url', $category->url ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Описание</label>
            <textarea class="form-control" rows="3" id="description"
                      name="description" placeholder="Введите описание">
                {{ old('description', $category->description ?? '') }}
            </textarea>
        </div>
        <div class="mb-3">
            <label for="meta_title" class="form-label">Meta-Заголовок</label>
            <input type="text" class="form-control"
                   placeholder="Введите Meta-Заголовок"
                   id="meta_title" name="meta_title"
                   value="{{ old('meta_title', $category->meta_title ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="meta_description" class="form-label">Meta-Описание</label>
            <input type="text" class="form-control"
                   placeholder="Введите Meta-Описание"
                   id="meta_description" name="meta_description"
                   value="{{ old('meta_description', $category->meta_description ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="meta_keywords" class="form-label">Meta-Ключевые слова</label>
            <input type="text" class="form-control"
                   placeholder="Введите Meta-Ключевые слова"
                   id="meta_keywords" name="meta_keywords"
                   value="{{ old('meta_keywords', $category->meta_keywords ?? '') }}">
        </div>
        <div class="mb-3">
            <label for="menu_status" class="form-check-label">Показывать в главном меню</label><br>
            <input type="checkbox" name="menu_status"
                   id="menu_status" class="form-check-input"
                   value="1" {{ !empty($category->menu_status) ? 'checked' : '' }}>
        </div>
    </div>
    <!--end::Body-->
    <!--begin::Footer-->
    <div class="card-footer">
        <button type="submit" class="btn btn-primary">Submit</button>
    </div>
    <!--end::Footer-->
</form>
```
Реализован полноценный дизайн формы с административным стилем и предварительным просмотром условных изображений/размеров.
## Шаг 5. Создайте ```addEditCategory()``` в ```CategoryService```
Обрабатывает логику вставки и обновления в одном методе:
- Загрузка файлов с помощью Intervention Image
- Изменение размера и сохранение изображения
- Форматирование URL-слага
- Очистка входных данных и значения по умолчанию
- Сохранение данных в таблицу категорий
```php
public function addEditCategory(Request $request): string
{
    $data = $request->all();

    if (isset($data['id']) && $data['id'] != '') {
        // Edit Category
        $category = Category::find($data['id']);
        $message = 'Category updated successfully!';
    } else {
        // Add Category
        $category = new Category();
        $message = 'Category added successfully!';
    }

    // Upload Category Image
    if ($request->hasFile('category_image')) {
        $image_tmp = $request->file('category_image');
        if ($image_tmp->isValid()) {
            $manager = new ImageManager(new Driver());
            $image = $manager->read($image_tmp);
            $extension = $image_tmp->getClientOriginalExtension();
            $filename = rand(111, 9999) . '.' . $extension;
            $image_path = 'front/images/categories/' . $filename;
            $image->save($image_path);
        }
    }

    // Upload Size Chart
    if ($request->hasFile('size_chart')) {
        $size_chart_tmp = $request->file('size_chart');
        if ($size_chart_tmp->isValid()) {
            $manager = new ImageManager(new Driver());
            $image = $manager->read($size_chart_tmp);
            $size_chart_extension = $size_chart_tmp->getClientOriginalExtension();
            $size_chart_filename = rand(111, 9999) . '.' . $size_chart_extension;
            $size_chart_image_path = 'front/images/size-charts/' . $size_chart_filename;
            $image->save($size_chart_image_path);
        }
    }

    $category->image = $data['image'];
    $category->size_chart = $data['size_chart'];

    // Format name and URL
    $data['category_name'] = str_replace('-', ' ', mb_convert_case(mb_strtolower($data['category_name']), MB_CASE_TITLE, "UTF-8"));
    $data['url'] = str_replace(' ', '-', mb_strtolower($data['url']));

    $category->name = $data['category_name'];

    // Discount default
    if (empty($data['category_discount'])) {
        $data['category_discount'] = 0;
    }

    $category->discount = $data['category_discount'];
    $category->description = $data['description'];
    $category->url = $data['url'];
    $category->meta_title = $data['meta_title'];
    $category->meta_description = $data['meta_description'];
    $category->meta_keywords = $data['meta_keywords'];

    // Menu status
    if (!empty($data['menu_status'])) {
        $category->menu_status = 1;
    } else {
        $category->menu_status = 0;
    }

    // Status default
    $category->status = 1;
    
    $category->save();
    return $message;
}
```
## Шаг 6. Обязательно импортируйте заголовки
В верхней части файла CategoryService.php добавьте:
```php
use Intervention\Image\Drivers\Gd\Driver;
use Intervention\Image\ImageManager;
```
## Шаг 7. Показать сообщение об успешном завершении в ```index.blade.php```
Отобразить флэш-сообщение после успешного добавления/обновления категории:
```html
@if(Session::has('success_message'))
    <div class="alert alert-success alert-dismissible fade show m-3" role="alert">
        <strong>Success: </strong> {{ Session::get('success_message') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
@endif
```
К концу этой части вы сможете динамически добавлять и редактировать категории из панели администратора.
# Что дальше?
В [следующей части](22.md) мы улучшим функционал добавления/редактирования категории, добавив раскрывающийся список родительской категории.

[Оглавление](../README.md)
